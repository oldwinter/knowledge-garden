"use strict";var v,V,C,T=require("obsidian");(function(a){a[a.DEFINED=1]="DEFINED",a[a.INFERRED=2]="INFERRED"})(v||(v={})),function(a){a[a.PARENT=0]="PARENT",a[a.CHILD=1]="CHILD",a[a.FRIEND=2]="FRIEND"}(V||(V={})),function(a){a[a.TO=1]="TO",a[a.FROM=2]="FROM",a[a.BOTH=3]="BOTH"}(C||(C={}));var Le=a=>{console.error(Object.assign({plugin:"ExcaliBrain"},a))},_e=console.log.bind(window.console);console.log.bind(window.console);var St=a=>`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(a.replaceAll("&nbsp;"," "))))}`;function ii(a){let e=a.lastIndexOf("/"),t=e==-1?a:a.substring(e+1);return{folderpath:T.normalizePath(a.substring(0,e)),filename:t,basename:t.replace(/\.[^/.]+$/,"")}}var Ke={target:null,isParent:!1,isChild:!1,isFriend:!1,direction:null},Xe=(a,e)=>a&&e?a+", "+e:a||e,$e=(a,e)=>a?a===C.BOTH||a===e?a:C.BOTH:e,qe=(a,e)=>a===v.DEFINED?v.DEFINED:a===v.INFERRED?e===v.DEFINED?v.DEFINED:v.INFERRED:e,J=class{constructor(e,t,i,n=!1,s=!1,o){this.path=e,this.file=t,this.plugin=i,this.isFolder=n,this.isTag=s,this.name=o,this.isChild=l=>{let{pi:d,pd:r,ci:h,cd:c,fd:y}=this.getRelationVector(l);return!c||r||y?d||r||!h||c||y?null:v.INFERRED:v.DEFINED},o||(this.name=t?t.extension==="md"?t.basename:t.name:(l=>{let d=l.endsWith(".md"),r=l.substring(l.lastIndexOf("/")+1);return d?r.slice(0,-3):r})(e)),this.mtime=t?t.stat.mtime:null,this.neighbours=new Map}getTitle(){var e,t,i,n;let s=this.file&&this.plugin.settings.renderAlias&&(n=(i=(t=(e=this.dvPage)===null||e===void 0?void 0:e.file)===null||t===void 0?void 0:t.aliases)===null||i===void 0?void 0:i.values)!==null&&n!==void 0?n:[];return s.length>0?s[0]:this.name}getRelationVector(e){return{pi:e.isParent&&e.parentType===v.INFERRED,pd:e.isParent&&e.parentType===v.DEFINED,ci:e.isChild&&e.childType===v.INFERRED,cd:e.isChild&&e.childType===v.DEFINED,fd:!this.plugin.settings.inferAllLinksAsFriends&&e.isFriend||this.plugin.settings.inferAllLinksAsFriends&&e.isFriend&&!(e.parentType===v.DEFINED||e.childType===v.DEFINED)}}getNeighbours(){let{showVirtualNodes:e,showAttachments:t,showFolderNodes:i,showTagNodes:n,showPageNodes:s}=this.plugin.settings;return Array.from(this.neighbours).filter(o=>(e||!o[1].target.isVirtual)&&(t||!o[1].target.isAttachment)&&(i||!o[1].target.isFolder)&&(n||!o[1].target.isTag)&&(s||o[1].target.isFolder||o[1].target.isTag))}get isVirtual(){return this.file===null&&!this.isFolder&&!this.isTag}get isAttachment(){return!!this.file&&this.file.extension!=="md"}get isMarkdown(){var e;return((e=this.file)===null||e===void 0?void 0:e.extension)==="md"||!this.file}addParent(e,t,i,n){if(e.path===this.plugin.settings.excalibrainFilepath)return;let s=this.neighbours.get(e.path);if(s)return s.isParent=!0,s.parentType=qe(s.parentType,t),s.parentTypeDefinition=Xe(n,s.parentTypeDefinition),void(s.direction=$e(s.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},Ke),{target:e,isParent:!0,parentType:t,parentTypeDefinition:n,direction:i}))}addChild(e,t,i,n){if(e.path===this.plugin.settings.excalibrainFilepath)return;let s=this.neighbours.get(e.path);if(s)return s.isChild=!0,s.childType=qe(s.childType,t),s.childTypeDefinition=Xe(n,s.childTypeDefinition),void(s.direction=$e(s.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},Ke),{target:e,isChild:!0,childType:t,childTypeDefinition:n,direction:i}))}addFriend(e,t,i,n){if(e.path===this.plugin.settings.excalibrainFilepath)return;let s=this.neighbours.get(e.path);if(s)return s.isFriend=!0,s.friendType=qe(s.friendType,t),s.friendTypeDefinition=Xe(n,s.friendTypeDefinition),void(s.direction=$e(s.direction,i));this.neighbours.set(e.path,Object.assign(Object.assign({},Ke),{target:e,isFriend:!0,friendType:t,friendTypeDefinition:n,direction:i}))}unlinkNeighbour(e){this.neighbours.delete(e)}hasChildren(){return this.getNeighbours().some(e=>{let t=this.isChild(e[1]);return t&&this.plugin.settings.showInferredNodes||t===v.DEFINED})}getChildren(){return this.getNeighbours().filter(e=>{let t=this.isChild(e[1]);return t&&this.plugin.settings.showInferredNodes||t===v.DEFINED}).map(e=>({page:e[1].target,relationType:e[1].childType,typeDefinition:e[1].childTypeDefinition,linkDirection:e[1].direction}))}isParent(e){let{pi:t,pd:i,ci:n,cd:s,fd:o}=this.getRelationVector(e);return s||!i||o?!t||i||n||s||o?null:v.INFERRED:v.DEFINED}hasParents(){return this.getNeighbours().some(e=>{let t=this.isParent(e[1]);return t&&this.plugin.settings.showInferredNodes||t===v.DEFINED})}getParents(){return this.getNeighbours().filter(e=>{let t=this.isParent(e[1]);return t&&this.plugin.settings.showInferredNodes||t===v.DEFINED}).map(e=>({page:e[1].target,relationType:e[1].parentType,typeDefinition:e[1].parentTypeDefinition,linkDirection:e[1].direction}))}isFriend(e){let{pi:t,pd:i,ci:n,cd:s,fd:o}=this.getRelationVector(e);return o?v.DEFINED:!t||i||!n||s||o?null:v.INFERRED}hasFriends(){return this.getNeighbours().some(e=>{let t=this.isFriend(e[1]);return t&&this.plugin.settings.showInferredNodes||t===v.DEFINED})}getFriends(){return this.getNeighbours().filter(e=>{let t=this.isFriend(e[1]);return t&&this.plugin.settings.showInferredNodes||t===v.DEFINED}).map(e=>{var t;return{page:e[1].target,relationType:(t=e[1].friendType)!==null&&t!==void 0?t:e[1].parentType===v.DEFINED&&e[1].childType===v.DEFINED?v.DEFINED:v.INFERRED,typeDefinition:e[1].friendTypeDefinition,linkDirection:e[1].direction}})}getRelationToPage(e){let t=this.neighbours.get(e.path);return t?this.isChild(t)?{type:"child",relationType:t.childType,typeDefinition:t.childTypeDefinition}:this.isParent(t)?{type:"parent",relationType:t.parentType,typeDefinition:t.parentTypeDefinition}:{type:"friend",relationType:t.friendType,typeDefinition:t.friendTypeDefinition}:null}getSiblings(){let e=new Map;return this.getParents().forEach(t=>t.page.getChildren().forEach(i=>{e.has(i.page.path)?i.relationType===v.DEFINED&&(e.get(i.page.path).relationType=v.DEFINED):e.set(i.page.path,i)})),Array.from(e.values())}},vt={};Object.defineProperty(vt,"__esModule",{value:!0});var bt=a=>{try{return window.ExcalidrawAutomate.getAPI(a)}catch(e){return console.log({message:"Excalidraw not available",fn:bt}),null}},Je=vt.getEA=bt,Pe=["base","inferred","file-tree","tag-tree"],wt={strokeColor:"#696969FF",strokeWidth:1,strokeStyle:"solid",roughness:0,startArrowHead:"none",endArrowHead:"none",showLabel:!1,fontSize:10,fontFamily:3,textColor:"#ffffffff"},Dt={prefix:"",backgroundColor:"#00000066",fillStyle:"solid",textColor:"#ffffffff",borderColor:"#00000000",fontSize:20,fontFamily:3,maxLabelLength:30,roughness:0,strokeShaprness:"round",strokeWidth:1,strokeStyle:"solid",padding:10,gateRadius:5,gateOffset:15,gateStrokeColor:"#ffffffff",gateBackgroundColor:"#ffffffff",gateFillStyle:"solid"},Lt={JSON_MALFORMED:"Malformed JSON",JSON_MISSING_KEYS:'JSON must have these 3 keys: "parents", "children", "friends"',JSON_VALUES_NOT_STRING_ARRAYS:'Key values must be a non-empty array of strings. e.g. "parents": ["Parent", "Parents", "up"]',EXCALIBRAIN_FILE_NAME:"Filepath of Excalibrain drawing",EXCALIBRAIN_FILE_DESC:"\u26A0 This file will be overwritten by the plugin. If you stop the script and make changes to the graph, you should rename the file so your edits are preserved, because the next time you initiate ExcaliBrain your edits will be overwritten by the automatically generated ExcaliBrain graph.",HIERARCHY_HEAD:"Hierarchy",HIERARCHY_DESC:"Enter the Dataview field names separated by comma (,) that you will use to define link directions in your graph.",INFER_NAME:"Infer all implicit relationships as Friend",INFER_DESC:"<b>Toggle On:</b> All implicit links in the document are interpreted as FRIENDS.<br><b>Toggle Off:</b> The following logic is used:<ul><li>A forward link is inferred as a CHILD</li><li>A backlink is inferred as a PARENT</li><li>If files mutually link to each other, they are FRIENDS</li></ul>",PARENTS_NAME:"Parents",CHILDREN_NAME:"Children",FRIENDS_NAME:"Friends",DISPLAY_HEAD:"Display",EXCLUDE_PATHLIST_NAME:"Filepaths to exclude",EXCLUDE_PATHLIST_DESC:"Enter comma-separated list of filepaths to exclude from the index.",RENDERALIAS_NAME:"Display alias if available",RENDERALIAS_DESC:"Displays the page alias instead of the filename if it is specified in the page's front matter.",SHOWINFERRED_NAME:"Display inferred relationships",SHOWINFERRED_DESC:"<b>Toggle ON</b>: Display both explicitly defined and inferred links. Forward links are children, backlinks are parents, if two page mutually referes to one another then relationship is inferred to be a friendship. Explicitly defined relationships always take priority.<br><b>Toggle OFF</b>: Display only explicitely defined relationships.",SHOWVIRTUAL_NAME:"Display virtual child nodes",SHOWVIRTUAL_DESC:"<b>Toggle ON</b>: Display unresolved links.<br><b>Toggle OFF</b>: Do not display unresolved links.",SHOWATTACHMENTS_NAME:"Include attachments",SHOWATTACHMENTS_DESC:"<b>Toggle ON</b>: Display every type of file on the graph. <br><b>Toggle OFF</b>: Display only markdown files.",STYLE_HEAD:"Styling",STYLE_DESC:"Styles are applied in sequence.<br><ol><li><b>Base</b> node style</li><li><b>Inferred</b> node style (only applied if the node is inferred)</li><li><b>Virtual</b> node style (only applied if the node is virtual)</li> <li><b>Central</b> node style (only applied if the node is in the center)</li><li><b>Sibling</b> node style (only applied if the node is a sibling)</li> <li><b>Attachment</b> node style (only applied if the node is an attachment)</li><li><b>Optional</b> tag based style</li></ol>All the attributes of the base node style must be specified. All other styles may have partial definitions. e.g. You may add a prefix and override the base node-background color in the tag-based style, override the font color in the inferred-node style and set the border stroke style to dotted in the virtual-node style.",CANVAS_BGCOLOR:"Canvas color",TAGLIST_NAME:"Formatted tags",TAGLIST_DESC:"You can specify special formatting rules for Nodes based on tags. If multiple tags are present on the page the first matching a specification will be used. <br>Tagnames should start with <mark>#</mark> and may be incomplete. i.e. <code>#book</code> will match #books, #book/fiction, etc.<br>Enter a comma separated list of tags here, then select from the dropdown list to change the formatting.",MAX_ITEMCOUNT_DESC:"Maximum node count",MAX_ITEMCOUNT_NAME:"Maximum number of nodes to display in a given area of the layout.i.e. the maximum number of parents, the maximum number of children, the maximum number of friends, and the maximum number of siblings to display. If there are more items, they will be ommitted from the drawing.",NODESTYLE_INCLUDE_TOGGLE:"Toggle ON: override base node style for this attribute; OFF: apply base node style for this attribute",NODESTYLE_PREFIX_NAME:"Prefix",NODESTYLE_PREFIX_DESC:"Prefix character or emoji to display in front of the node's label",NODESTYLE_BGCOLOR:"Background color",NODESTYLE_BG_FILLSTYLE:"Bacground fill-style",NODESTYLE_TEXTCOLOR:"Text color",NODESTYLE_BORDERCOLOR:"Border color",NODESTYLE_FONTSIZE:"Font size",NODESTYLE_FONTFAMILY:"Font family",NODESTYLE_MAXLABELLENGTH_NAME:"Max label length",NODESTYLE_MAXLABELLENGTH_DESC:"Maximum number of characters to display from node title. Longer nodes will end with '...'",NODESTYLE_ROUGHNESS:"Stroke roughness",NODESTYLE_SHARPNESS:"Stroke sharpness",NODESTYLE_STROKEWIDTH:"Stroke width",NODESTYLE_STROKESTYLE:"Stroke style",NODESTYLE_RECTANGLEPADDING:"Padding of the node rectangle",NODESTYLE_GATE_RADIUS_NAME:"Gate radius",NODESTYLE_GATE_RADIUS_DESC:"The radius of the 3 small circles (alias: gates) serving as connection points for nodes",NODESTYLE_GATE_OFFSET_NAME:"Gate offset",NODESTYLE_GATE_OFFSET_DESC:"The offset to the left and right of the parent and child gates.",NODESTYLE_GATE_COLOR:"Gate border color",NODESTYLE_GATE_BGCOLOR_NAME:"Gate background color",NODESTYLE_GATE_BGCOLOR_DESC:"The fill color of the gate if it has children",NODESTYLE_GATE_FILLSTYLE:"Gate background fill-style",NODESTYLE_BASE:"Base node style",NODESTYLE_CENTRAL:"Style of central node",NODESTYLE_INFERRED:"Style of inferred nodes",NODESTYLE_VIRTUAL:"Style of virtual nodes",NODESTYLE_SIBLING:"Style of sibling nodes",NODESTYLE_ATTACHMENT:"Style of attachment nodes",NODESTYLE_FOLDER:"Style of folder nodes",NODESTYLE_TAG:"Style of tag nodes",LINKSTYLE_COLOR:"Color",LINKSTYLE_WIDTH:"Width",LINKSTYLE_STROKE:"Stroke style",LINKSTYLE_ROUGHNESS:"Roughness",LINKSTYLE_ARROWSTART:"Start arrow head",LINKSTYLE_ARROWEND:"End arrow head",LINKSTYLE_SHOWLABEL:"Show label on link",LINKSTYLE_FONTSIZE:"Label font size",LINKSTYLE_FONTFAMILY:"Label font family",LINKSTYLE_BASE:"Base link style",LINKSTYLE_INFERRED:"Style of inferred link",LINKSTYLE_FOLDER:"Style of folder link",LINKSTYLE_TAG:"Style of tag link",DATAVIEW_NOT_FOUND:"Dataview plugin not found. Please install or enable Dataview then try restarting ExcaliBrain.",EXCALIDRAW_NOT_FOUND:"Excalidraw plugin not found. Please install or enable Excalidraw then try restarting ExcaliBrain.",EXCALIDRAW_MINAPP_VERSION:"ExcaliBrain requires Excalidraw 1.6.33 or higher. Please upgrade Excalidraw then try restarting ExcaliBrain.",COMMAND_START:"ExcaliBrain Normal",COMMAND_START_HOVER:"ExcaliBrain Hover-Editor",COMMAND_STOP:"Stop ExcaliBrain",HOVER_EDITOR_ERROR:"I am sorry. Something went wrong. Most likely there was a version update to Hover Editor which I haven't addressed properly in ExcaliBrain. Normally I should get this fixed within few days",OPEN_DRAWING:"Save snapshot for editing",SEARCH_IN_VAULT:`Starred items will be listed in empty search.
Search for a file, a folder or a tag in your Vault.
Toggle folders and tags on/off to show in the list.`,SHOW_HIDE_ATTACHMENTS:"Show/Hide attachments",SHOW_HIDE_VIRTUAL:"Show/Hide virtual nodes",SHOW_HIDE_INFERRED:"Show/Hide inferred nodes",SHOW_HIDE_ALIAS:"Show/Hide document alias",SHOW_HIDE_SIBLINGS:"Show/Hide siblings",SHOW_HIDE_FOLDER:"Show/Hide folder nodes",SHOW_HIDE_TAG:"Show/Hide tag nodes",SHOW_HIDE_PAGES:"Show/Hide page nodes (incl. defined, inferred, virtual and attachments)",PIN_LEAF:"Link ExcaliBrain to most recent active leaf"},Ze={en:Lt}[T.moment.locale()];function p(a){return Ze||Le({fn:p,where:"src/lang/helpers.ts",message:"Error: locale not found",data:T.moment.locale()}),Ze&&Ze[a]||Lt[a]}var me=class extends T.Modal{constructor(e,t,i){super(e),this.title=t,this.message=i}onOpen(){this.createForm()}onClose(){}createForm(){this.titleEl.setText(this.title),this.contentEl.createDiv({cls:"excalibrain-prompt-center",text:this.message}),this.contentEl.createDiv({cls:"excalibrain-prompt-center"},e=>{e.style.textAlign="right",e.createEl("button",{text:"Ok"}).onclick=()=>{this.resolve(!0),this.close()},e.createEl("button",{text:"Cancel"}).onclick=()=>{this.resolve(!1),this.close()}})}show(e){this.resolve=e,this.open()}},He=(a,e,t)=>{let i=a.metadataCache.getFirstLinkpathDest(e,t);return i?i.path:e},Tt=(a,e)=>{let t=new Set,i=a.matchAll(/[^[]*\[\[([^#\]\|]*)[^\]]*]]/g),n;for(;!(n=i.next()).done;)if(n.value[1]){let s=He(app,n.value[1],e.path);s&&t.add(s)}return Array.from(t)},Qe=(a,e,t)=>{let i=[],n=new Set;return t.forEach(s=>{let o=e[s];o&&!n.has(s)&&(n.add(s),((l,d,r)=>{var h;let c=new Set;if(d.values){if(d.values.filter(y=>y.type==="file"||y.type==="header").forEach(y=>{let u=He(l,y.path,r.path);u&&c.add(u)}),c.size>0)return Array.from(c);if(typeof d.values[0]=="string")return Tt(d.values.join(" "),r);if(typeof d.values[0]=="object"&&typeof d.values[0].values[0]=="string")return[He(l,(h=d.values[0])===null||h===void 0?void 0:h.values[0],r.path)]}if(d.path){let y=He(l,d.path,r.path);return y?[y]:[]}return Tt(d,r)})(a.app,o,e.file).forEach(l=>i.push({link:l,field:s})))}),i},Te=(a,e)=>{var t,i,n;return a?((n=(i=(t=a.file)===null||t===void 0?void 0:t.tags)===null||i===void 0?void 0:i.values)!==null&&n!==void 0?n:[]).filter(s=>e.tagStyleList.some(o=>s.startsWith(o)))[0]:null},Nt=(a,e)=>a?e.tagNodeStyles[e.tagStyleList.filter(t=>a.startsWith(t))[0]]:{},ye=class{constructor(e){this.style={},this.center={x:0,y:0},this.page=e.page,this.settings=e.page.plugin.settings,this.ea=e.page.plugin.EA,this.page.isFolder?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.folderNodeStyle):this.page.isTag?this.style=Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),this.settings.tagNodeStyle):this.style=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.settings.baseNodeStyle),e.isInferred?this.settings.inferredNodeStyle:{}),e.page.isVirtual?this.settings.virtualNodeStyle:{}),e.isCentral?this.settings.centralNodeStyle:{}),e.isSibling?this.settings.siblingNodeStyle:{}),e.page.isAttachment?this.settings.attachmentNodeStyle:{}),Nt(this.page.primaryStyleTag,this.settings)),this.friendGateOnLeft=e.friendGateOnLeft,this.title=this.page.getTitle()}displayText(){var e;let t=((e=this.style.prefix)!==null&&e!==void 0?e:"")+this.title;return t.length>this.style.maxLabelLength?t.substring(0,this.style.maxLabelLength-1)+"...":t}setCenter(e){this.center=e}render(){var e,t;let i=this.ea,n=this.displayText();i.style.fontSize=this.style.fontSize,i.style.fontFamily=this.style.fontFamily;let s=i.measureText(n);i.style.fillStyle=this.style.fillStyle,i.style.roughness=this.style.roughness,i.style.strokeSharpness=this.style.strokeShaprness,i.style.strokeWidth=this.style.strokeWidth,i.style.strokeColor=this.style.textColor,i.style.backgroundColor="transparent",this.id=i.addText(this.center.x-s.width/2,this.center.y-s.height/2,n,{wrapAt:this.style.maxLabelLength+5,textAlign:"center",box:!0,boxPadding:this.style.padding});let o=i.getElement(this.id);o.link=`[[${(t=(e=this.page.file)===null||e===void 0?void 0:e.path)!==null&&t!==void 0?t:this.page.path}]]`,o.backgroundColor=this.style.backgroundColor,o.strokeColor=this.style.borderColor,o.strokeStyle=this.style.strokeStyle,i.style.fillStyle=this.style.gateFillStyle,i.style.strokeColor=this.style.gateStrokeColor,i.style.strokeStyle="solid",i.style.backgroundColor=this.page.hasFriends()?this.style.gateBackgroundColor:"transparent",this.friendGateId=i.addEllipse(this.friendGateOnLeft?this.center.x-2*this.style.gateRadius-this.style.padding-s.width/2:this.center.x+this.style.padding+s.width/2,this.center.y-this.style.gateRadius,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasParents()?this.style.gateBackgroundColor:"transparent",this.parentGateId=i.addEllipse(this.center.x-this.style.gateRadius-this.style.gateOffset,this.center.y-2*this.style.gateRadius-this.style.padding-s.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.style.backgroundColor=this.page.hasChildren()?this.style.gateBackgroundColor:"transparent",this.childGateId=i.addEllipse(this.center.x-this.style.gateRadius+this.style.gateOffset,this.center.y+this.style.padding+s.height/2,2*this.style.gateRadius,2*this.style.gateRadius),i.addToGroup([this.friendGateId,this.parentGateId,this.childGateId,this.id,o.boundElements[0].id])}},et=class{constructor(e,t,i,n,s,o,l,d){this.nodeA=e,this.nodeB=t,this.nodeBRole=i,this.hierarchyDefinition=s,this.ea=o,this.isInferred=!1;let r=s==null?void 0:s.split(",").map(c=>c.trim());this.isInferred=n===v.INFERRED;let h={};r&&r.forEach(c=>{if(d.hierarchyLinkStylesExtended[c])h=Object.assign(Object.assign({},h),d.hierarchyLinkStylesExtended[c]);else switch(c){case"file-tree":h=Object.assign(Object.assign({},h),d.settings.folderLinkStyle);break;case"tag-tree":h=Object.assign(Object.assign({},h),d.settings.tagLinkStyle)}}),this.style=Object.assign(Object.assign(Object.assign({},l.baseLinkStyle),this.isInferred?l.inferredLinkStyle:{}),h)}render(e){let t=this.ea,i=this.style,n,s;switch(t.style.strokeStyle=i.strokeStyle,t.style.roughness=i.roughness,t.style.strokeColor=i.strokeColor,t.style.strokeWidth=i.strokeWidth,t.style.opacity=e?10:100,this.nodeBRole){case V.CHILD:n=this.nodeA.childGateId,s=this.nodeB.parentGateId;break;case V.PARENT:n=this.nodeA.parentGateId,s=this.nodeB.childGateId;break;default:n=this.nodeA.friendGateId,s=this.nodeB.friendGateId}let o=t.connectObjects(n,null,s,null,{startArrowHead:i.startArrowHead==="none"?null:i.startArrowHead,endArrowHead:i.endArrowHead==="none"?null:i.endArrowHead});i.showLabel&&this.hierarchyDefinition&&(t.style.fontSize=i.fontSize,t.style.fontFamily=i.fontFamily,t.style.strokeColor=i.textColor,t.addLabelToLine(o,this.hierarchyDefinition))}},si={excalibrainFilepath:"excalibrain.md",hierarchy:{parents:["Parent","Parents","up","u"],children:["Children","Child","down","d"],friends:["Friends","Friend","Jump","Jumps","j"]},inferAllLinksAsFriends:!1,renderAlias:!0,backgroundColor:"#0c3e6aff",excludeFilepaths:[],showInferredNodes:!0,showAttachments:!0,showVirtualNodes:!0,showFolderNodes:!1,showTagNodes:!1,showPageNodes:!0,maxItemCount:30,renderSiblings:!0,baseNodeStyle:Dt,centralNodeStyle:{fontSize:30,backgroundColor:"#C49A13FF",textColor:"#000000ff"},inferredNodeStyle:{backgroundColor:"#000005b3",textColor:"#95c7f3ff"},virtualNodeStyle:{backgroundColor:"#ff000066",fillStyle:"hachure",textColor:"#ffffffff"},siblingNodeStyle:{fontSize:15},attachmentNodeStyle:{prefix:"\u{1F4CE} "},folderNodeStyle:{prefix:"\u{1F4C2} ",strokeShaprness:"sharp",borderColor:"#ffd700ff",textColor:"#ffd700ff"},tagNodeStyle:{prefix:"#",strokeShaprness:"sharp",borderColor:"#4682b4ff",textColor:"#4682b4ff"},tagNodeStyles:{},tagStyleList:[],baseLinkStyle:wt,inferredLinkStyle:{strokeStyle:"dashed"},folderLinkStyle:{strokeColor:"#ffd700ff"},tagLinkStyle:{strokeColor:"#4682b4ff"},hierarchyLinkStyles:{},navigationHistory:[]},j="excalibrain-settings-disabled",tt=a=>(255*a|256).toString(16).slice(1),G=a=>createFragment(e=>e.createDiv().innerHTML=a),it=a=>{let e=document.getElementById(a);if(!e)return;let t=e.parentNode;t&&t.removeChild(e)},Ot=(a,e)=>{let t=document.createElement("style");t.id=a,t.innerHTML=`.${e} {display: none;}`,document.body.appendChild(t)},xt=class extends T.PluginSettingTab{constructor(e,t){super(e,t),this.dirty=!1,this.plugin=t}get hierarchyStyleList(){return Pe.concat(Array.from(this.plugin.settings.hierarchy.parents)).concat(Array.from(this.plugin.settings.hierarchy.children)).concat(Array.from(this.plugin.settings.hierarchy.friends))}async updateNodeDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor,this.demoNode.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),this.demoNode.render();let e=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);e.removeAttribute("width"),e.removeAttribute("height"),this.demoNodeImg.setAttribute("src",St(e.outerHTML))}async updateLinkDemoImg(){this.ea.reset(),this.ea.canvas.viewBackgroundColor=this.plugin.settings.backgroundColor;let e=new J("Start node",null,this.plugin),t=new J("End node",null,this.plugin),i=this.plugin.settings.hierarchy;i.friends.contains(this.demoLinkStyle.display)?(e.addFriend(t,v.DEFINED,C.FROM),t.addFriend(e,v.DEFINED,C.TO)):i.parents.contains(this.demoLinkStyle.display)?(e.addParent(t,v.DEFINED,C.FROM),t.addChild(e,v.DEFINED,C.TO)):(e.addChild(t,v.DEFINED,C.FROM),t.addParent(e,v.DEFINED,C.TO));let n=new ye({page:e,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});n.ea=this.ea,n.setCenter({x:0,y:0});let s=new ye({page:t,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!1});s.ea=this.ea;let o=V.CHILD;i.friends.contains(this.demoLinkStyle.display)?(s.setCenter({x:-300,y:0}),o=V.FRIEND):i.parents.contains(this.demoLinkStyle.display)?(s.setCenter({x:0,y:-150}),o=V.PARENT):s.setCenter({x:0,y:150});let l=new et(n,s,o,v.DEFINED,"base",this.ea,this.plugin.settings,this.plugin);n.style=Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),this.plugin.settings.centralNodeStyle),n.render(),s.style=Object.assign(Object.assign({},this.demoNodeStyle.getInheritedStyle()),this.demoNodeStyle.style),s.render(),l.style=Object.assign(Object.assign({},this.demoLinkStyle.getInheritedStyle()),this.demoLinkStyle.style),l.render(!1);let d=await this.ea.createSVG(null,!0,{withBackground:!0,withTheme:!1},null,"",40);d.removeAttribute("width"),d.removeAttribute("height"),this.demoLinkImg.setAttribute("src",St(d.outerHTML))}async hide(){var e;this.dirty&&(this.plugin.setHierarchyLinkStylesExtended(),this.plugin.settings.tagStyleList=Object.keys(this.plugin.settings.tagNodeStyles),this.plugin.saveSettings(),(e=this.plugin.scene)===null||e===void 0||e.reRender())}colorpicker(e,t,i,n,s,o,l,d){let r,h,c,y,u,E,m=new T.Setting(e).setName(t);i&&m.setDesc(G(i));let D=L=>{L?m.settingEl.addClass(j):m.settingEl.removeClass(j),h.disabled=L,h.style.opacity=L?"0.3":"1",r.setDisabled(L),r.sliderEl.style.opacity=L?"0.3":"1",y.style.opacity=L?"0.3":"1",u.style.opacity=L?"0.3":"1",E.style.opacity=L?"0.3":"1"};l&&m.addToggle(L=>{c=L,L.toggleEl.addClass("excalibrain-settings-toggle"),L.setValue(n()!==void 0).setTooltip(p("NODESTYLE_INCLUDE_TOGGLE")).onChange(N=>{if(this.dirty=!0,!N)return D(!0),void o();s(h.value+tt(r.getValue())),D(!1)})}),m.settingEl.removeClass("mod-toggle"),y=createEl("span",{text:"color:",cls:"excalibrain-settings-colorlabel"}),m.controlEl.appendChild(y),h=createEl("input",{type:"color",cls:"excalibrain-settings-colorpicker"},L=>{var N;L.value=((N=n())!==null&&N!==void 0?N:d).substring(0,7),L.onchange=()=>{s(L.value+tt(r.getValue()))}}),m.controlEl.appendChild(h),u=createEl("span",{text:"opacity:",cls:"excalibrain-settings-opacitylabel"}),m.controlEl.appendChild(u),m.addSlider(L=>{var N,x;r=L,L.setLimits(0,1,.1).setValue((x=(N=n())!==null&&N!==void 0?N:d,parseInt(x.substring(7,9),16)/255)).onChange(O=>{s(h.value+tt(O)),E.innerText=` ${O.toString()}`,h.style.opacity=O.toString()})}),E=createDiv({text:`${r.getValue().toString()}`,cls:"excalibrain-settings-sliderlabel"}),m.controlEl.appendChild(E),h.style.opacity=r.getValue().toString(),D(l&&!c.getValue())}numberslider(e,t,i,n,s,o,l,d,r){let h,c,y,u=new T.Setting(e).setName(t),E=m=>{m?u.settingEl.addClass(j):u.settingEl.removeClass(j),y.setDisabled(m),y.sliderEl.style.opacity=m?"0.3":"1",h.style.opacity=m?"0.3":"1"};d&&u.addToggle(m=>{c=m,m.toggleEl.addClass("excalibrain-settings-toggle"),m.setValue(s()!==void 0).setTooltip(p("NODESTYLE_INCLUDE_TOGGLE")).onChange(D=>{if(this.dirty=!0,!D)return E(!0),void l();o(y.getValue()),E(!1)})}),u.addSlider(m=>{var D;y=m,m.setLimits(n.min,n.max,n.step).setValue((D=s())!==null&&D!==void 0?D:r).onChange(async L=>{h.innerText=` ${L.toString()}`,o(L),this.dirty=!0})}),i&&u.setDesc(G(i)),u.settingEl.createDiv("",m=>{h=m,m.style.minWidth="2.3em",m.style.textAlign="right",m.innerText=` ${y.getValue().toString()}`}),E(d&&!c.getValue())}toggle(e,t,i,n,s,o,l,d){let r,h,c=new T.Setting(e).setName(t),y=u=>{u?c.settingEl.addClass(j):c.settingEl.removeClass(j),h.setDisabled(u),h.toggleEl.style.opacity=u?"0.3":"1"};l&&c.addToggle(u=>{r=u,u.toggleEl.addClass("excalibrain-settings-toggle"),u.setValue(n()!==void 0).setTooltip(p("NODESTYLE_INCLUDE_TOGGLE")).onChange(E=>{if(this.dirty=!0,!E)return y(!0),void o();s(h.getValue()),y(!1)})}),c.addToggle(u=>{var E;h=u,u.setValue((E=n())!==null&&E!==void 0?E:d).onChange(async m=>{s(m),this.dirty=!0})}),i&&c.setDesc(G(i)),y(l&&!r.getValue())}dropdownpicker(e,t,i,n,s,o,l,d,r){let h,c,y=new T.Setting(e).setName(t),u=E=>{E?y.settingEl.addClass(j):y.settingEl.removeClass(j),h.setDisabled(E),h.selectEl.style.opacity=E?"0.3":"1"};d&&y.addToggle(E=>{c=E,E.toggleEl.addClass("excalibrain-settings-toggle"),E.setValue(s()!==void 0).setTooltip(p("NODESTYLE_INCLUDE_TOGGLE")).onChange(m=>{if(this.dirty=!0,!m)return u(!0),void l();o(h.getValue()),u(!1)})}),y.addDropdown(E=>{var m;h=E,E.addOptions(n).setValue((m=s())!==null&&m!==void 0?m:r).onChange(D=>{o(D),this.dirty=!0})}),i&&y.setDesc(G(i)),u(d&&!c.getValue())}nodeSettings(e,t,i=!0,n){let s,o,l=new T.Setting(e).setName(p("NODESTYLE_PREFIX_NAME")).setDesc(G(p("NODESTYLE_PREFIX_DESC"))),d=r=>{r?l.settingEl.addClass(j):l.settingEl.removeClass(j),s.setDisabled(r),s.inputEl.style.opacity=r?"0.3":"1"};i&&l.addToggle(r=>{o=r,r.toggleEl.addClass("excalibrain-settings-toggle"),r.setValue(t.prefix!==void 0).setTooltip(p("NODESTYLE_INCLUDE_TOGGLE")).onChange(h=>{if(this.dirty=!0,!h)return d(!0),t.prefix=void 0,void this.updateNodeDemoImg();d(!1)})}),l.addText(r=>{var h;s=r,r.setValue((h=t.prefix)!==null&&h!==void 0?h:n.prefix).onChange(c=>{t.prefix=c,this.updateNodeDemoImg(),this.dirty=!0})}),d(i&&!o.getValue()),this.colorpicker(e,p("NODESTYLE_BGCOLOR"),null,()=>t.backgroundColor,r=>{t.backgroundColor=r,this.updateNodeDemoImg()},()=>{delete t.backgroundColor,this.updateNodeDemoImg()},i,n.backgroundColor),this.dropdownpicker(e,p("NODESTYLE_BG_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},()=>{var r;return(r=t.fillStyle)===null||r===void 0?void 0:r.toString()},r=>{t.fillStyle=r,this.updateNodeDemoImg()},()=>{delete t.fillStyle,this.updateNodeDemoImg()},i,n.fillStyle.toString()),this.colorpicker(e,p("NODESTYLE_TEXTCOLOR"),null,()=>t.textColor,r=>{t.textColor=r,this.updateNodeDemoImg()},()=>{delete t.textColor,this.updateNodeDemoImg()},i,n.textColor),this.colorpicker(e,p("NODESTYLE_BORDERCOLOR"),null,()=>t.borderColor,r=>{t.borderColor=r,this.updateNodeDemoImg()},()=>{delete t.borderColor,this.updateNodeDemoImg()},i,n.borderColor),this.numberslider(e,p("NODESTYLE_FONTSIZE"),null,{min:10,max:50,step:5},()=>t.fontSize,r=>{t.fontSize=r,this.updateNodeDemoImg()},()=>{delete t.fontSize,this.updateNodeDemoImg()},i,n.fontSize),this.dropdownpicker(e,p("NODESTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},()=>{var r;return(r=t.fontFamily)===null||r===void 0?void 0:r.toString()},r=>{t.fontFamily=parseInt(r),this.updateNodeDemoImg()},()=>{delete t.fontFamily,this.updateNodeDemoImg()},i,n.fontFamily.toString()),this.numberslider(e,p("NODESTYLE_MAXLABELLENGTH_NAME"),p("NODESTYLE_MAXLABELLENGTH_DESC"),{min:15,max:100,step:5},()=>t.maxLabelLength,r=>{t.maxLabelLength=r,this.updateNodeDemoImg()},()=>{delete t.maxLabelLength,this.updateNodeDemoImg()},i,n.maxLabelLength),this.dropdownpicker(e,p("NODESTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},()=>{var r;return(r=t.roughness)===null||r===void 0?void 0:r.toString()},r=>{t.roughness=parseInt(r),this.updateNodeDemoImg()},()=>{delete t.roughness,this.updateNodeDemoImg()},i,n.roughness.toString()),this.dropdownpicker(e,p("NODESTYLE_SHARPNESS"),null,{sharp:"Sharp",round:"Round"},()=>t.strokeShaprness,r=>{t.strokeShaprness=r,this.updateNodeDemoImg()},()=>{delete t.strokeShaprness,this.updateNodeDemoImg()},i,n.strokeShaprness),this.numberslider(e,p("NODESTYLE_STROKEWIDTH"),null,{min:.5,max:6,step:.5},()=>t.strokeWidth,r=>{t.strokeWidth=r,this.updateNodeDemoImg()},()=>{delete t.strokeWidth,this.updateNodeDemoImg()},i,n.strokeWidth),this.dropdownpicker(e,p("NODESTYLE_STROKESTYLE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},()=>t.strokeStyle,r=>{t.strokeStyle=r,this.updateNodeDemoImg()},()=>{delete t.strokeStyle,this.updateNodeDemoImg()},i,n.strokeStyle),this.numberslider(e,p("NODESTYLE_RECTANGLEPADDING"),null,{min:5,max:50,step:5},()=>t.padding,r=>{t.padding=r,this.updateNodeDemoImg()},()=>{delete t.padding,this.updateNodeDemoImg()},i,n.padding),this.numberslider(e,p("NODESTYLE_GATE_RADIUS_NAME"),p("NODESTYLE_GATE_RADIUS_DESC"),{min:3,max:10,step:1},()=>t.gateRadius,r=>{t.gateRadius=r,this.updateNodeDemoImg()},()=>{delete t.gateRadius,this.updateNodeDemoImg()},i,n.gateRadius),this.numberslider(e,p("NODESTYLE_GATE_OFFSET_NAME"),p("NODESTYLE_GATE_OFFSET_DESC"),{min:0,max:25,step:1},()=>t.gateOffset,r=>{t.gateOffset=r,this.updateNodeDemoImg()},()=>{delete t.gateOffset,this.updateNodeDemoImg()},i,n.gateOffset),this.colorpicker(e,p("NODESTYLE_GATE_COLOR"),null,()=>t.gateStrokeColor,r=>{t.gateStrokeColor=r,this.updateNodeDemoImg()},()=>{delete t.gateStrokeColor,this.updateNodeDemoImg()},i,n.gateStrokeColor),this.colorpicker(e,p("NODESTYLE_GATE_BGCOLOR_NAME"),p("NODESTYLE_GATE_BGCOLOR_DESC"),()=>t.gateBackgroundColor,r=>{t.gateBackgroundColor=r,this.updateNodeDemoImg()},()=>{delete t.gateBackgroundColor,this.updateNodeDemoImg()},i,n.gateBackgroundColor),this.dropdownpicker(e,p("NODESTYLE_GATE_FILLSTYLE"),null,{hachure:"Hachure","cross-hatch":"Cross-hatch",solid:"Solid"},()=>{var r;return(r=t.gateFillStyle)===null||r===void 0?void 0:r.toString()},r=>{t.gateFillStyle=r,this.updateNodeDemoImg()},()=>{delete t.gateFillStyle,this.updateNodeDemoImg()},i,n.gateFillStyle.toString())}linkSettings(e,t,i=!0,n){this.colorpicker(e,p("LINKSTYLE_COLOR"),null,()=>t.strokeColor,s=>{t.strokeColor=s,this.updateLinkDemoImg()},()=>{delete t.strokeColor,this.updateLinkDemoImg()},i,n.strokeColor),this.numberslider(e,p("LINKSTYLE_WIDTH"),null,{min:.5,max:10,step:.5},()=>t.strokeWidth,s=>{t.strokeWidth=s,this.updateLinkDemoImg()},()=>{delete t.strokeWidth,this.updateLinkDemoImg()},i,n.strokeWidth),this.dropdownpicker(e,p("LINKSTYLE_ROUGHNESS"),null,{0:"Architect",1:"Artist",2:"Cartoonist"},()=>{var s;return(s=t.roughness)===null||s===void 0?void 0:s.toString()},s=>{t.roughness=parseInt(s),this.updateLinkDemoImg()},()=>{delete t.roughness,this.updateLinkDemoImg()},i,n.roughness.toString()),this.dropdownpicker(e,p("LINKSTYLE_STROKE"),null,{solid:"Solid",dashed:"Dashed",dotted:"Dotted"},()=>t.strokeStyle,s=>{t.strokeStyle=s,this.updateLinkDemoImg()},()=>{delete t.strokeStyle,this.updateLinkDemoImg()},i,n.strokeStyle),this.dropdownpicker(e,p("LINKSTYLE_ARROWSTART"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},()=>t.startArrowHead,s=>{t.startArrowHead=s===""?null:s,this.updateLinkDemoImg()},()=>{delete t.startArrowHead,this.updateLinkDemoImg()},i,n.startArrowHead),this.dropdownpicker(e,p("LINKSTYLE_ARROWEND"),null,{none:"None",arrow:"Arrow",bar:"Bar",dot:"Dot",triangle:"Triangle"},()=>t.endArrowHead,s=>{t.endArrowHead=s===""?null:s,this.updateLinkDemoImg()},()=>{delete t.endArrowHead,this.updateLinkDemoImg()},i,n.endArrowHead),this.toggle(e,p("LINKSTYLE_SHOWLABEL"),null,()=>t.showLabel,s=>{t.showLabel=s,this.updateLinkDemoImg()},()=>{delete t.showLabel,this.updateLinkDemoImg()},i,n.showLabel),this.colorpicker(e,p("NODESTYLE_TEXTCOLOR"),null,()=>t.textColor,s=>{t.textColor=s,this.updateLinkDemoImg()},()=>{delete t.textColor,this.updateLinkDemoImg()},i,n.textColor),this.numberslider(e,p("LINKSTYLE_FONTSIZE"),null,{min:6,max:30,step:3},()=>t.fontSize,s=>{t.fontSize=s,this.updateLinkDemoImg()},()=>{delete t.fontSize,this.updateLinkDemoImg()},i,n.fontSize),this.dropdownpicker(e,p("LINKSTYLE_FONTFAMILY"),null,{1:"Hand-drawn",2:"Normal",3:"Code",4:"Fourth (custom) Font"},()=>{var s;return(s=t.fontFamily)===null||s===void 0?void 0:s.toString()},s=>{t.fontFamily=parseInt(s),this.updateLinkDemoImg()},()=>{delete t.fontFamily,this.updateLinkDemoImg()},i,n.fontFamily.toString())}async display(){await this.plugin.loadSettings(),this.ea=Je();let e=new J("This is a demo node that is 46 characters long",null,this.plugin),t=new J("This is a child node",null,this.plugin);e.addChild(t,v.DEFINED,C.FROM),t.addParent(e,v.DEFINED,C.TO),this.demoNode=new ye({page:e,isInferred:!1,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.demoNode.ea=this.ea,this.demoNode.setCenter({x:0,y:0});let{containerEl:i}=this;this.containerEl.empty();let n=i.createDiv("coffee");n.addClass("ex-coffee-div"),n.createEl("a",{href:"https://ko-fi.com/zsolt"}).createEl("img",{attr:{src:"https://cdn.ko-fi.com/cdn/kofi3.png?v=3"}}).height=45,new T.Setting(i).setName(p("EXCALIBRAIN_FILE_NAME")).setDesc(G(p("EXCALIBRAIN_FILE_DESC"))).addText(g=>g.setValue(this.plugin.settings.excalibrainFilepath).onChange(f=>{this.dirty=!0,f.endsWith(".md")||(f+=f.endsWith(".m")?"d":f.endsWith(".")?"md":".md"),this.app.vault.getAbstractFileByPath(f)?new me(this.app,"\u26A0 File Exists",`${f} already exists in your Vault. Is it ok to overwrite this file?`).show(w=>{w&&(this.plugin.settings.excalibrainFilepath=f,this.dirty=!0,g.inputEl.value=f)}):(this.plugin.settings.excalibrainFilepath=f,this.dirty=!0)}).inputEl.onblur=()=>{g.setValue(this.plugin.settings.excalibrainFilepath)}),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:p("HIERARCHY_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=p("HIERARCHY_DESC");let s,o,l=()=>{};new T.Setting(i).setName(p("PARENTS_NAME")).addText(g=>{g.inputEl.style.width="100%",g.setValue(this.plugin.settings.hierarchy.parents.join(", ")).onChange(f=>{this.plugin.settings.hierarchy.parents=f.split(",").map(w=>w.trim()),this.plugin.hierarchyLowerCase.parents=[],this.plugin.settings.hierarchy.parents.forEach(w=>this.plugin.hierarchyLowerCase.parents.push(w.toLowerCase().replaceAll(" ","-"))),l(),this.dirty=!0})}),new T.Setting(i).setName(p("CHILDREN_NAME")).addText(g=>{g.inputEl.style.width="100%",g.setValue(this.plugin.settings.hierarchy.children.join(", ")).onChange(f=>{this.plugin.settings.hierarchy.children=f.split(",").map(w=>w.trim()),this.plugin.hierarchyLowerCase.children=[],this.plugin.settings.hierarchy.children.forEach(w=>this.plugin.hierarchyLowerCase.children.push(w.toLowerCase().replaceAll(" ","-"))),l(),this.dirty=!0})}),new T.Setting(i).setName(p("FRIENDS_NAME")).addText(g=>{g.inputEl.style.width="100%",g.setValue(this.plugin.settings.hierarchy.friends.join(", ")).onChange(f=>{this.plugin.settings.hierarchy.friends=f.split(",").map(w=>w.trim()),this.plugin.hierarchyLowerCase.friends=[],this.plugin.settings.hierarchy.friends.forEach(w=>this.plugin.hierarchyLowerCase.friends.push(w.toLowerCase().replaceAll(" ","-"))),l(),this.dirty=!0})}),new T.Setting(i).setName(p("INFER_NAME")).setDesc(G(p("INFER_DESC"))).addToggle(g=>g.setValue(this.plugin.settings.inferAllLinksAsFriends).onChange(f=>{this.plugin.settings.inferAllLinksAsFriends=f,this.dirty=!0})),this.containerEl.createEl("h1",{cls:"excalibrain-settings-h1",text:p("DISPLAY_HEAD")}),new T.Setting(i).setName(p("EXCLUDE_PATHLIST_NAME")).setDesc(G(p("EXCLUDE_PATHLIST_DESC"))).addTextArea(g=>{g.inputEl.style.height="100px",g.inputEl.style.width="100%",g.setValue(this.plugin.settings.excludeFilepaths.join(", ")).onChange(f=>{let w=(f=f.replaceAll(`
`," ")).split(",").map(b=>b.trim());this.plugin.settings.excludeFilepaths=w.filter(b=>b!==""),this.dirty=!0})}).descEl.style.maxWidth="400px",new T.Setting(i).setName(p("RENDERALIAS_NAME")).setDesc(G(p("RENDERALIAS_DESC"))).addToggle(g=>g.setValue(this.plugin.settings.renderAlias).onChange(f=>{this.plugin.settings.renderAlias=f,this.dirty=!0})),new T.Setting(i).setName(p("SHOWINFERRED_NAME")).setDesc(G(p("SHOWINFERRED_DESC"))).addToggle(g=>g.setValue(this.plugin.settings.showInferredNodes).onChange(f=>{this.plugin.settings.showInferredNodes=f,this.dirty=!0})),new T.Setting(i).setName(p("SHOWATTACHMENTS_NAME")).setDesc(G(p("SHOWATTACHMENTS_DESC"))).addToggle(g=>g.setValue(this.plugin.settings.showAttachments).onChange(f=>{this.plugin.settings.showAttachments=f,this.dirty=!0})),new T.Setting(i).setName(p("SHOWVIRTUAL_NAME")).setDesc(G(p("SHOWVIRTUAL_DESC"))).addToggle(g=>g.setValue(this.plugin.settings.showVirtualNodes).onChange(f=>{this.plugin.settings.showVirtualNodes=f,this.dirty=!0})),this.numberslider(i,p("MAX_ITEMCOUNT_NAME"),p("MAX_ITEMCOUNT_DESC"),{min:5,max:150,step:5},()=>this.plugin.settings.maxItemCount,g=>this.plugin.settings.maxItemCount=g,()=>{},!1,30),i.createEl("h1",{cls:"excalibrain-settings-h1",text:p("STYLE_HEAD")}),this.containerEl.createEl("p",{}).innerHTML=p("STYLE_DESC"),this.colorpicker(i,p("CANVAS_BGCOLOR"),null,()=>this.plugin.settings.backgroundColor,g=>{this.plugin.settings.backgroundColor=g,this.updateNodeDemoImg()},()=>{},!1,this.plugin.settings.backgroundColor);let d=g=>{o.empty();let f=this.plugin.nodeStyles[g];this.nodeSettings(o,f.style,f.allowOverride,f.getInheritedStyle()),this.demoNodeStyle=f,this.updateNodeDemoImg()};new T.Setting(i).setName(p("TAGLIST_NAME")).setDesc(p("TAGLIST_DESC")).addTextArea(g=>{g.inputEl.style.height="200px",g.inputEl.style.width="100%",g.setValue(this.plugin.settings.tagStyleList.join(", ")).onChange(f=>{let w=this.plugin.settings.tagNodeStyles,b=this.plugin.nodeStyles,k=(f=f.replaceAll(`
`," ")).split(",").map(I=>I.trim());this.plugin.settings.tagStyleList=k,Object.keys(w).forEach(I=>{k.contains(I)||(delete w[I],delete b[I])}),k.forEach(I=>{Object.keys(w).contains(I)||(w[I]={},b[I]={style:w[I],allowOverride:!0,userStyle:!0,display:I,getInheritedStyle:()=>this.plugin.settings.baseNodeStyle})});let F=s.getValue();for(let I=s.selectEl.options.length-1;I>=0;I--)s.selectEl.remove(I);Object.entries(b).forEach(I=>{s.addOption(I[0],I[1].display)}),b[F]?s.setValue(F):(s.setValue("base"),d("base")),this.dirty=!0})}).descEl.style.maxWidth="400px";let r=i.createDiv({cls:"setting-item"}),h=r.createDiv({cls:"setting-item-info"}),c;s=new T.DropdownComponent(h),r.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px";let y=!1,u=new T.ToggleComponent(r);u.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange(g=>{y?y=!1:(g?it("excalibrain-hide-disabled"):Ot("excalibrain-hide-disabled",j),y=!0,c.setValue(g))}),Object.entries(this.plugin.nodeStyles).forEach(g=>{s.addOption(g[0],g[1].display)}),this.demoNodeImg=i.createEl("img",{cls:"excalibrain-settings-demoimg"}),o=i.createDiv({cls:"excalibrain-setting-style-section"}),it("excalibrain-hide-disabled"),s.setValue("base").onChange(d);let E=this.plugin.nodeStyles.base,m,D;this.nodeSettings(o,E.style,E.allowOverride,E.getInheritedStyle()),this.demoNodeStyle=E,this.updateNodeDemoImg();let L=g=>{D.empty();let f=this.plugin.linkStyles[g];this.linkSettings(D,f.style,f.allowOverride,f.getInheritedStyle()),this.demoLinkStyle=f,this.updateLinkDemoImg()},N=i.createDiv({cls:"setting-item"}),x=N.createDiv({cls:"setting-item-info"});m=new T.DropdownComponent(x),N.createDiv({text:"Show inherited",cls:"setting-item-name"}).style.marginRight="10px",c=new T.ToggleComponent(N),c.setValue(!0).setTooltip("Show/Hide Inherited Properties").onChange(g=>{y?y=!1:(g?it("excalibrain-hide-disabled"):Ot("excalibrain-hide-disabled",j),y=!0,u.setValue(g))}),Object.entries(this.plugin.linkStyles).forEach(g=>{m.addOption(g[0],g[1].display)}),this.demoLinkImg=i.createEl("img",{cls:"excalibrain-settings-demoimg"}),D=i.createDiv({cls:"excalibrain-setting-nodestyle-section"}),m.setValue("base").onChange(L);let O=this.plugin.linkStyles.base;this.linkSettings(D,O.style,O.allowOverride,O.getInheritedStyle()),this.demoLinkStyle=O,this.updateLinkDemoImg(),l=()=>{let g=this.plugin.settings.hierarchyLinkStyles,f=this.plugin.linkStyles;Object.keys(f).forEach(b=>{Pe.contains(b)||this.hierarchyStyleList.contains(b)||(delete f[b],delete g[b])}),this.hierarchyStyleList.forEach(b=>{Object.keys(g).contains(b)||Pe.contains(b)||(g[b]={},f[b]={style:g[b],allowOverride:!0,userStyle:!0,display:b,getInheritedStyle:()=>this.plugin.settings.baseLinkStyle})});let w=m.getValue();for(let b=m.selectEl.options.length-1;b>=0;b--)m.selectEl.remove(b);Object.entries(f).forEach(b=>{m.addOption(b[0],b[1].display)}),f[w]?m.setValue(w):(m.setValue("base"),L("base"))},l()}},st={};Object.defineProperty(st,"__esModule",{value:!0});var ni=st.getAPI=a=>{var e;return a?(e=a.plugins.plugins.dataview)===null||e===void 0?void 0:e.api:window.DataviewAPI};st.isPluginEnabled=a=>a.plugins.enabledPlugins.has("dataview");var It=class{constructor(e){this.pages=new Map,this.forEach=this.pages.forEach.bind(this.pages),this.app=e.app,this.plugin=e}add(e,t){this.pages.set(e,t)}has(e){return this.pages.has(e)}get(e){return this.pages.get(e)}getPages(){return Array.from(this.pages.values())}get size(){return this.pages.size}delete(e){let t=this.pages.get(e);t&&(t.neighbours.forEach((i,n)=>{let s=this.pages.get(n);s&&(s.unlinkNeighbour(e),s.file||s.neighbours.size!==0||this.pages.delete(n))}),this.pages.delete(e))}addResolvedLinks(e){let t=this.app.metadataCache.resolvedLinks;Object.keys(t).forEach(i=>{if(e&&e.path!==i)return;let n=this.pages.get(i);Object.keys(t[i]).forEach(s=>{let o=this.pages.get(s);this.plugin.settings.inferAllLinksAsFriends?(o.addFriend(n,v.INFERRED,C.FROM),n.addFriend(o,v.INFERRED,C.TO)):(o.addParent(n,v.INFERRED,C.FROM),n.addChild(o,v.INFERRED,C.TO))})})}addUnresolvedLinks(e){if(e&&(e.isFolder||e.isTag))return;let t=this.app.metadataCache.unresolvedLinks;Object.keys(t).forEach(i=>{if(e&&e.path!==i)return;let n=this.pages.get(i);i!==this.plugin.settings.excalibrainFilepath&&Object.keys(t[i]).forEach(s=>{var o;let l=(o=this.get(s))!==null&&o!==void 0?o:new J(s,null,this.plugin);this.plugin.settings.inferAllLinksAsFriends?(l.addFriend(n,v.INFERRED,C.FROM),n.addFriend(l,v.INFERRED,C.TO)):(l.addParent(n,v.INFERRED,C.FROM),n.addChild(l,v.INFERRED,C.TO)),this.add(s,l)})})}addDVFieldLinksToPage(e){var t,i,n;if(e.isFolder||e.isTag)return;let s=this.plugin.DVAPI.page(e.file.path);if(!s||(e.dvPage=s,!s))return;((n=(i=(t=s.file)===null||t===void 0?void 0:t.etags)===null||i===void 0?void 0:i.values)!==null&&n!==void 0?n:[]).forEach(r=>{r="tag:"+r.substring(1);let h=this.pages.get(r);h&&(e.addParent(h,v.DEFINED,C.FROM,"tag-tree"),h.addChild(e,v.DEFINED,C.TO,"tag-tree"))});let o=this.plugin.hierarchyLowerCase.parents;Qe(this.plugin,s,o).forEach(r=>{let h=this.pages.get(r.link);h?(e.addParent(h,v.DEFINED,C.TO,r.field),h.addChild(e,v.DEFINED,C.FROM,r.field)):_e(`Unexpected: ${e.file.path} references ${r.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)});let l=this.plugin.hierarchyLowerCase.children;Qe(this.plugin,s,l).forEach(r=>{let h=this.pages.get(r.link);h?(e.addChild(h,v.DEFINED,C.TO,r.field),h.addParent(e,v.DEFINED,C.FROM,r.field)):_e(`Unexpected: ${e.file.path} references ${r.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)});let d=this.plugin.hierarchyLowerCase.friends;Qe(this.plugin,s,d).forEach(r=>{let h=this.pages.get(r.link);h?(e.addFriend(h,v.DEFINED,C.TO,r.field),h.addFriend(e,v.DEFINED,C.FROM,r.field)):_e(`Unexpected: ${e.file.path} references ${r.link} in DV, but it was not found in app.metadataCache. The page was skipped.`)})}},Ct=`---

excalidraw-plugin: parsed
excalidraw-default-mode: view
excalidraw-export-dark: false
excalidraw-export-transparent: false
excalidraw-linkbutton-opacity: 0.3
excalidraw-onload-script: "app.plugins.plugins[${String.fromCharCode(96)}excalibrain${String.fromCharCode(96)}].start(ea.targetView.leaf);"

tags: [excalidraw]

---

# Text Elements
Open a document in another pane and click it to get started.

For the best experience enable 'Open in adjacent pane'
in Excalidraw settings under 'Links and Transclusion'. ^4mylk7KK

%%
# Drawing
${String.fromCharCode(96,96,96)}json
{
	"type": "excalidraw",
	"version": 2,
	"source": "https://excalidraw.com",
	"elements": [
		{
			"type": "text",
			"version": 1,
			"versionNonce": 423577018,
			"isDeleted": false,
			"id": "4mylk7KK",
			"fillStyle": "hachure",
			"strokeWidth": 1,
			"strokeStyle": "solid",
			"roughness": 1,
			"opacity": 100,
			"angle": 0,
			"x": 0,
			"y": 0,
			"strokeColor": "white",
			"backgroundColor": "transparent",
			"width": 703,
			"height": 96,
			"seed": 4429,
			"groupIds": [],
			"strokeSharpness": "sharp",
			"boundElements": [],
			"updated": 1650784785611,
			"link": null,
			"locked": false,
			"fontSize": 20,
			"fontFamily": 3,
			"text": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",
			"rawText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'.",
			"baseline": 91,
			"textAlign": "center",
			"verticalAlign": "top",
			"containerId": null,
			"originalText": "Open a document in another pane and click it to get started.\\n\\nFor the best experience enable 'Open in adjacent pane'\\nin Excalidraw settings under 'Links and Transclusion'."
		}
	],
	"appState": {
		"theme": "dark",
		"viewBackgroundColor": "hsl(208, 80%, 23%)",
		"currentItemStrokeColor": "#000000",
		"currentItemBackgroundColor": "transparent",
		"currentItemFillStyle": "hachure",
		"currentItemStrokeWidth": 2,
		"currentItemStrokeStyle": "solid",
		"currentItemRoughness": 1,
		"currentItemOpacity": 100,
		"currentItemFontFamily": 1,
		"currentItemFontSize": 16,
		"currentItemTextAlign": "left",
		"currentItemStrokeSharpness": "sharp",
		"currentItemStartArrowhead": null,
		"currentItemEndArrowhead": "arrow",
		"currentItemLinearStrokeSharpness": "round",
		"gridSize": null,
		"colorPalette": {}
	},
	"files": {}
}
${String.fromCharCode(96,96,96)}
%%
`,Ee=class{constructor(e){this.nodes=[],this.renderedNodes=[],this.spec=e}layout(e=this.spec.columns){let t=this.nodes.sort((s,o)=>s.title.toLowerCase()<o.title.toLowerCase()?-1:1),i=t.length;if(i===0)return;let n=Math.ceil(i/e);this.renderedNodes=Array(n).fill(null).map((s,o)=>{return o+1<n||i%e==0?Array(e).fill(null).map((d,r)=>t[o*e+r]):(l=i%e,(d=>{let r=[],h=1,c=!0;return d.map(y=>Math.floor(y)).forEach(y=>{for(let u=0;u<y;u++)r.push(c?null:h++);c=!c}),r})(l%2?[(e-l)/2,l,(e-l)/2]:[(e-l)/2,l/2,1,l/2,(e-l)/2])).map(d=>d?t[o*e+d-1]:null);var l})}render(){this.layout();let e=this.renderedNodes.length*this.spec.rowHeight,t=this.spec.top===null&&this.spec.bottom===null?this.spec.origoY-e/2:this.spec.top!==null?this.spec.origoY-e/2<this.spec.top?this.spec.top:this.spec.origoY-e/2:this.spec.origoY+e/2>this.spec.bottom?this.spec.bottom-e:this.spec.origoY-e/2,i=this.spec.origoX-(this.spec.columns===1?0:(this.spec.columns-1)/2*this.spec.columnWidth),n=t;this.renderedNodes.forEach((s,o)=>s.forEach((l,d)=>{l&&(l.setCenter({x:i+d*this.spec.columnWidth,y:n+o*this.spec.rowHeight}),l.render())}))}},nt=class{constructor(e){this.plugin=e,this.links=new Map,this.reverseLinks=new Set}addLink(e,t,i,n,s,o,l,d){let r=e.page.path+"|:?:|"+t.page.path;if(this.links.has(r)||this.reverseLinks.has(r))return;let h=t.page.path+"|:?:|"+e.page.path,c=new et(o===C.FROM?t:e,o===C.FROM?e:t,o===C.FROM?i===V.FRIEND?V.FRIEND:i===V.CHILD?V.PARENT:V.CHILD:i,n,s,l,d,this.plugin);this.links.set(r,c),this.reverseLinks.add(h)}render(e){this.links.forEach(t=>t.render(e.some(i=>{var n;return(n=t.hierarchyDefinition)===null||n===void 0?void 0:n.includes(i)})||t.isInferred&&e.includes("inferred-link")))}},ee=class{constructor(e,t,i,n,s,o=!0){this.getVal=t,this.updateIndex=o,this.button=n.createEl("button",{cls:"excalibrain-button"}),this.button.createSpan({text:s.display}),this.button.ariaLabel=s.tooltip,this.setColor(),this.button.onclick=()=>{var l;i(!t()),e.saveSettings(),this.setColor(),(l=e.scene)===null||l===void 0||l.reRender(this.updateIndex)}}setColor(){if(this.getVal())return this.button.removeClass("off"),void this.button.addClass("on");this.button.removeClass("on"),this.button.addClass("off")}},B="top",U="bottom",z="right",Y="left",Ne=[B,U,z,Y],kt=Ne.reduce(function(a,e){return a.concat([e+"-start",e+"-end"])},[]),At=[].concat(Ne,["auto"]).reduce(function(a,e){return a.concat([e,e+"-start",e+"-end"])},[]),ai=["beforeRead","read","afterRead","beforeMain","main","afterMain","beforeWrite","write","afterWrite"];function te(a){return a?(a.nodeName||"").toLowerCase():null}function Z(a){if(a==null)return window;if(a.toString()!=="[object Window]"){var e=a.ownerDocument;return e&&e.defaultView||window}return a}function Se(a){return a instanceof Z(a).Element||a instanceof Element}function K(a){return a instanceof Z(a).HTMLElement||a instanceof HTMLElement}function at(a){return typeof ShadowRoot!="undefined"&&(a instanceof Z(a).ShadowRoot||a instanceof ShadowRoot)}var ri={name:"applyStyles",enabled:!0,phase:"write",fn:function(a){var e=a.state;Object.keys(e.elements).forEach(function(t){var i=e.styles[t]||{},n=e.attributes[t]||{},s=e.elements[t];K(s)&&te(s)&&(Object.assign(s.style,i),Object.keys(n).forEach(function(o){var l=n[o];l===!1?s.removeAttribute(o):s.setAttribute(o,l===!0?"":l)}))})},effect:function(a){var e=a.state,t={popper:{position:e.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(e.elements.popper.style,t.popper),e.styles=t,e.elements.arrow&&Object.assign(e.elements.arrow.style,t.arrow),function(){Object.keys(e.elements).forEach(function(i){var n=e.elements[i],s=e.attributes[i]||{},o=Object.keys(e.styles.hasOwnProperty(i)?e.styles[i]:t[i]).reduce(function(l,d){return l[d]="",l},{});K(n)&&te(n)&&(Object.assign(n.style,o),Object.keys(s).forEach(function(l){n.removeAttribute(l)}))})}},requires:["computeStyles"]};function ie(a){return a.split("-")[0]}var de=Math.max,Me=Math.min,ve=Math.round;function be(a,e){e===void 0&&(e=!1);var t=a.getBoundingClientRect(),i=1,n=1;if(K(a)&&e){var s=a.offsetHeight,o=a.offsetWidth;o>0&&(i=ve(t.width)/o||1),s>0&&(n=ve(t.height)/s||1)}return{width:t.width/i,height:t.height/n,top:t.top/n,right:t.right/i,bottom:t.bottom/n,left:t.left/i,x:t.left/i,y:t.top/n}}function rt(a){var e=be(a),t=a.offsetWidth,i=a.offsetHeight;return Math.abs(e.width-t)<=1&&(t=e.width),Math.abs(e.height-i)<=1&&(i=e.height),{x:a.offsetLeft,y:a.offsetTop,width:t,height:i}}function Ft(a,e){var t=e.getRootNode&&e.getRootNode();if(a.contains(e))return!0;if(t&&at(t)){var i=e;do{if(i&&a.isSameNode(i))return!0;i=i.parentNode||i.host}while(i)}return!1}function se(a){return Z(a).getComputedStyle(a)}function oi(a){return["table","td","th"].indexOf(te(a))>=0}function oe(a){return((Se(a)?a.ownerDocument:a.document)||window.document).documentElement}function Ve(a){return te(a)==="html"?a:a.assignedSlot||a.parentNode||(at(a)?a.host:null)||oe(a)}function Rt(a){return K(a)&&se(a).position!=="fixed"?a.offsetParent:null}function Oe(a){for(var e=Z(a),t=Rt(a);t&&oi(t)&&se(t).position==="static";)t=Rt(t);return t&&(te(t)==="html"||te(t)==="body"&&se(t).position==="static")?e:t||function(i){var n=navigator.userAgent.toLowerCase().indexOf("firefox")!==-1;if(navigator.userAgent.indexOf("Trident")!==-1&&K(i)&&se(i).position==="fixed")return null;var s=Ve(i);for(at(s)&&(s=s.host);K(s)&&["html","body"].indexOf(te(s))<0;){var o=se(s);if(o.transform!=="none"||o.perspective!=="none"||o.contain==="paint"||["transform","perspective"].indexOf(o.willChange)!==-1||n&&o.willChange==="filter"||n&&o.filter&&o.filter!=="none")return s;s=s.parentNode}return null}(a)||e}function ot(a){return["top","bottom"].indexOf(a)>=0?"x":"y"}function xe(a,e,t){return de(a,Me(e,t))}function _t(a){return Object.assign({},{top:0,right:0,bottom:0,left:0},a)}function Pt(a,e){return e.reduce(function(t,i){return t[i]=a,t},{})}var li={name:"arrow",enabled:!0,phase:"main",fn:function(a){var e,t=a.state,i=a.name,n=a.options,s=t.elements.arrow,o=t.modifiersData.popperOffsets,l=ie(t.placement),d=ot(l),r=[Y,z].indexOf(l)>=0?"height":"width";if(s&&o){var h=function(b,k){return _t(typeof(b=typeof b=="function"?b(Object.assign({},k.rects,{placement:k.placement})):b)!="number"?b:Pt(b,Ne))}(n.padding,t),c=rt(s),y=d==="y"?B:Y,u=d==="y"?U:z,E=t.rects.reference[r]+t.rects.reference[d]-o[d]-t.rects.popper[r],m=o[d]-t.rects.reference[d],D=Oe(s),L=D?d==="y"?D.clientHeight||0:D.clientWidth||0:0,N=E/2-m/2,x=h[y],O=L-c[r]-h[u],g=L/2-c[r]/2+N,f=xe(x,g,O),w=d;t.modifiersData[i]=((e={})[w]=f,e.centerOffset=f-g,e)}},effect:function(a){var e=a.state,t=a.options.element,i=t===void 0?"[data-popper-arrow]":t;i!=null&&(typeof i!="string"||(i=e.elements.popper.querySelector(i)))&&Ft(e.elements.popper,i)&&(e.elements.arrow=i)},requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function we(a){return a.split("-")[1]}var hi={top:"auto",right:"auto",bottom:"auto",left:"auto"};function Ht(a){var e,t=a.popper,i=a.popperRect,n=a.placement,s=a.variation,o=a.offsets,l=a.position,d=a.gpuAcceleration,r=a.adaptive,h=a.roundOffsets,c=a.isFixed,y=o.x,u=y===void 0?0:y,E=o.y,m=E===void 0?0:E,D=typeof h=="function"?h({x:u,y:m}):{x:u,y:m};u=D.x,m=D.y;var L=o.hasOwnProperty("x"),N=o.hasOwnProperty("y"),x=Y,O=B,g=window;if(r){var f=Oe(t),w="clientHeight",b="clientWidth";f===Z(t)&&se(f=oe(t)).position!=="static"&&l==="absolute"&&(w="scrollHeight",b="scrollWidth"),f=f,(n===B||(n===Y||n===z)&&s==="end")&&(O=U,m-=(c&&f===g&&g.visualViewport?g.visualViewport.height:f[w])-i.height,m*=d?1:-1),n!==Y&&(n!==B&&n!==U||s!=="end")||(x=z,u-=(c&&f===g&&g.visualViewport?g.visualViewport.width:f[b])-i.width,u*=d?1:-1)}var k,F=Object.assign({position:l},r&&hi),I=h===!0?function(S){var A=S.x,X=S.y,P=window.devicePixelRatio||1;return{x:ve(A*P)/P||0,y:ve(X*P)/P||0}}({x:u,y:m}):{x:u,y:m};return u=I.x,m=I.y,d?Object.assign({},F,((k={})[O]=N?"0":"",k[x]=L?"0":"",k.transform=(g.devicePixelRatio||1)<=1?"translate("+u+"px, "+m+"px)":"translate3d("+u+"px, "+m+"px, 0)",k)):Object.assign({},F,((e={})[O]=N?m+"px":"",e[x]=L?u+"px":"",e.transform="",e))}var We={passive:!0},di={left:"right",right:"left",bottom:"top",top:"bottom"};function Be(a){return a.replace(/left|right|bottom|top/g,function(e){return di[e]})}var ci={start:"end",end:"start"};function Mt(a){return a.replace(/start|end/g,function(e){return ci[e]})}function lt(a){var e=Z(a);return{scrollLeft:e.pageXOffset,scrollTop:e.pageYOffset}}function ht(a){return be(oe(a)).left+lt(a).scrollLeft}function dt(a){var e=se(a),t=e.overflow,i=e.overflowX,n=e.overflowY;return/auto|scroll|overlay|hidden/.test(t+n+i)}function Vt(a){return["html","body","#document"].indexOf(te(a))>=0?a.ownerDocument.body:K(a)&&dt(a)?a:Vt(Ve(a))}function Ie(a,e){var t;e===void 0&&(e=[]);var i=Vt(a),n=i===((t=a.ownerDocument)==null?void 0:t.body),s=Z(i),o=n?[s].concat(s.visualViewport||[],dt(i)?i:[]):i,l=e.concat(o);return n?l:l.concat(Ie(Ve(o)))}function ct(a){return Object.assign({},a,{left:a.x,top:a.y,right:a.x+a.width,bottom:a.y+a.height})}function Wt(a,e){return e==="viewport"?ct(function(t){var i=Z(t),n=oe(t),s=i.visualViewport,o=n.clientWidth,l=n.clientHeight,d=0,r=0;return s&&(o=s.width,l=s.height,/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(d=s.offsetLeft,r=s.offsetTop)),{width:o,height:l,x:d+ht(t),y:r}}(a)):Se(e)?function(t){var i=be(t);return i.top=i.top+t.clientTop,i.left=i.left+t.clientLeft,i.bottom=i.top+t.clientHeight,i.right=i.left+t.clientWidth,i.width=t.clientWidth,i.height=t.clientHeight,i.x=i.left,i.y=i.top,i}(e):ct(function(t){var i,n=oe(t),s=lt(t),o=(i=t.ownerDocument)==null?void 0:i.body,l=de(n.scrollWidth,n.clientWidth,o?o.scrollWidth:0,o?o.clientWidth:0),d=de(n.scrollHeight,n.clientHeight,o?o.scrollHeight:0,o?o.clientHeight:0),r=-s.scrollLeft+ht(t),h=-s.scrollTop;return se(o||n).direction==="rtl"&&(r+=de(n.clientWidth,o?o.clientWidth:0)-l),{width:l,height:d,x:r,y:h}}(oe(a)))}function Bt(a){var e,t=a.reference,i=a.element,n=a.placement,s=n?ie(n):null,o=n?we(n):null,l=t.x+t.width/2-i.width/2,d=t.y+t.height/2-i.height/2;switch(s){case B:e={x:l,y:t.y-i.height};break;case U:e={x:l,y:t.y+t.height};break;case z:e={x:t.x+t.width,y:d};break;case Y:e={x:t.x-i.width,y:d};break;default:e={x:t.x,y:t.y}}var r=s?ot(s):null;if(r!=null){var h=r==="y"?"height":"width";switch(o){case"start":e[r]=e[r]-(t[h]/2-i[h]/2);break;case"end":e[r]=e[r]+(t[h]/2-i[h]/2)}}return e}function Ce(a,e){e===void 0&&(e={});var t=e,i=t.placement,n=i===void 0?a.placement:i,s=t.boundary,o=s===void 0?"clippingParents":s,l=t.rootBoundary,d=l===void 0?"viewport":l,r=t.elementContext,h=r===void 0?"popper":r,c=t.altBoundary,y=c!==void 0&&c,u=t.padding,E=u===void 0?0:u,m=_t(typeof E!="number"?E:Pt(E,Ne)),D=h==="popper"?"reference":"popper",L=a.rects.popper,N=a.elements[y?D:h],x=function(I,S,A){var X=S==="clippingParents"?function(R){var ae=Ie(Ve(R)),W=["absolute","fixed"].indexOf(se(R).position)>=0&&K(R)?Oe(R):R;return Se(W)?ae.filter(function(M){return Se(M)&&Ft(M,W)&&te(M)!=="body"}):[]}(I):[].concat(S),P=[].concat(X,[A]),H=P[0],_=P.reduce(function(R,ae){var W=Wt(I,ae);return R.top=de(W.top,R.top),R.right=Me(W.right,R.right),R.bottom=Me(W.bottom,R.bottom),R.left=de(W.left,R.left),R},Wt(I,H));return _.width=_.right-_.left,_.height=_.bottom-_.top,_.x=_.left,_.y=_.top,_}(Se(N)?N:N.contextElement||oe(a.elements.popper),o,d),O=be(a.elements.reference),g=Bt({reference:O,element:L,strategy:"absolute",placement:n}),f=ct(Object.assign({},L,g)),w=h==="popper"?f:O,b={top:x.top-w.top+m.top,bottom:w.bottom-x.bottom+m.bottom,left:x.left-w.left+m.left,right:w.right-x.right+m.right},k=a.modifiersData.offset;if(h==="popper"&&k){var F=k[n];Object.keys(b).forEach(function(I){var S=[z,U].indexOf(I)>=0?1:-1,A=[B,U].indexOf(I)>=0?"y":"x";b[I]+=F[A]*S})}return b}var pi={name:"flip",enabled:!0,phase:"main",fn:function(a){var e=a.state,t=a.options,i=a.name;if(!e.modifiersData[i]._skip){for(var n=t.mainAxis,s=n===void 0||n,o=t.altAxis,l=o===void 0||o,d=t.fallbackPlacements,r=t.padding,h=t.boundary,c=t.rootBoundary,y=t.altBoundary,u=t.flipVariations,E=u===void 0||u,m=t.allowedAutoPlacements,D=e.options.placement,L=ie(D),N=d||(L!==D&&E?function(M){if(ie(M)==="auto")return[];var $=Be(M);return[Mt(M),$,Mt($)]}(D):[Be(D)]),x=[D].concat(N).reduce(function(M,$){return M.concat(ie($)==="auto"?function(ce,re){re===void 0&&(re={});var q=re,ke=q.placement,Ae=q.boundary,pe=q.rootBoundary,Ye=q.padding,je=q.flipVariations,ge=q.allowedAutoPlacements,Ge=ge===void 0?At:ge,De=we(ke),Fe=De?je?kt:kt.filter(function(Q){return we(Q)===De}):Ne,ue=Fe.filter(function(Q){return Ge.indexOf(Q)>=0});ue.length===0&&(ue=Fe);var fe=ue.reduce(function(Q,le){return Q[le]=Ce(ce,{placement:le,boundary:Ae,rootBoundary:pe,padding:Ye})[ie(le)],Q},{});return Object.keys(fe).sort(function(Q,le){return fe[Q]-fe[le]})}(e,{placement:$,boundary:h,rootBoundary:c,padding:r,flipVariations:E,allowedAutoPlacements:m}):$)},[]),O=e.rects.reference,g=e.rects.popper,f=new Map,w=!0,b=x[0],k=0;k<x.length;k++){var F=x[k],I=ie(F),S=we(F)==="start",A=[B,U].indexOf(I)>=0,X=A?"width":"height",P=Ce(e,{placement:F,boundary:h,rootBoundary:c,altBoundary:y,padding:r}),H=A?S?z:Y:S?U:B;O[X]>g[X]&&(H=Be(H));var _=Be(H),R=[];if(s&&R.push(P[I]<=0),l&&R.push(P[H]<=0,P[_]<=0),R.every(function(M){return M})){b=F,w=!1;break}f.set(F,R)}if(w)for(var ae=function(M){var $=x.find(function(ce){var re=f.get(ce);if(re)return re.slice(0,M).every(function(q){return q})});if($)return b=$,"break"},W=E?3:1;W>0&&ae(W)!=="break";W--);e.placement!==b&&(e.modifiersData[i]._skip=!0,e.placement=b,e.reset=!0)}},requiresIfExists:["offset"],data:{_skip:!1}};function Yt(a,e,t){return t===void 0&&(t={x:0,y:0}),{top:a.top-e.height-t.y,right:a.right-e.width+t.x,bottom:a.bottom-e.height+t.y,left:a.left-e.width-t.x}}function jt(a){return[B,z,U,Y].some(function(e){return a[e]>=0})}function gi(a,e,t){t===void 0&&(t=!1);var i,n,s=K(e),o=K(e)&&function(c){var y=c.getBoundingClientRect(),u=ve(y.width)/c.offsetWidth||1,E=ve(y.height)/c.offsetHeight||1;return u!==1||E!==1}(e),l=oe(e),d=be(a,o),r={scrollLeft:0,scrollTop:0},h={x:0,y:0};return(s||!s&&!t)&&((te(e)!=="body"||dt(l))&&(r=(i=e)!==Z(i)&&K(i)?{scrollLeft:(n=i).scrollLeft,scrollTop:n.scrollTop}:lt(i)),K(e)?((h=be(e,!0)).x+=e.clientLeft,h.y+=e.clientTop):l&&(h.x=ht(l))),{x:d.left+r.scrollLeft-h.x,y:d.top+r.scrollTop-h.y,width:d.width,height:d.height}}function ui(a){var e=new Map,t=new Set,i=[];function n(s){t.add(s.name),[].concat(s.requires||[],s.requiresIfExists||[]).forEach(function(o){if(!t.has(o)){var l=e.get(o);l&&n(l)}}),i.push(s)}return a.forEach(function(s){e.set(s.name,s)}),a.forEach(function(s){t.has(s.name)||n(s)}),i}var Gt={placement:"bottom",modifiers:[],strategy:"absolute"};function Ut(){for(var a=arguments.length,e=new Array(a),t=0;t<a;t++)e[t]=arguments[t];return!e.some(function(i){return!(i&&typeof i.getBoundingClientRect=="function")})}var zt,fi=function(a){a===void 0&&(a={});var e=a,t=e.defaultModifiers,i=t===void 0?[]:t,n=e.defaultOptions,s=n===void 0?Gt:n;return function(o,l,d){d===void 0&&(d=s);var r,h,c={placement:"bottom",orderedModifiers:[],options:Object.assign({},Gt,s),modifiersData:{},elements:{reference:o,popper:l},attributes:{},styles:{}},y=[],u=!1,E={state:c,setOptions:function(D){var L=typeof D=="function"?D(c.options):D;m(),c.options=Object.assign({},s,c.options,L),c.scrollParents={reference:Se(o)?Ie(o):o.contextElement?Ie(o.contextElement):[],popper:Ie(l)};var N,x,O=function(g){var f=ui(g);return ai.reduce(function(w,b){return w.concat(f.filter(function(k){return k.phase===b}))},[])}((N=[].concat(i,c.options.modifiers),x=N.reduce(function(g,f){var w=g[f.name];return g[f.name]=w?Object.assign({},w,f,{options:Object.assign({},w.options,f.options),data:Object.assign({},w.data,f.data)}):f,g},{}),Object.keys(x).map(function(g){return x[g]})));return c.orderedModifiers=O.filter(function(g){return g.enabled}),c.orderedModifiers.forEach(function(g){var f=g.name,w=g.options,b=w===void 0?{}:w,k=g.effect;if(typeof k=="function"){var F=k({state:c,name:f,instance:E,options:b});y.push(F||function(){})}}),E.update()},forceUpdate:function(){if(!u){var D=c.elements,L=D.reference,N=D.popper;if(Ut(L,N)){c.rects={reference:gi(L,Oe(N),c.options.strategy==="fixed"),popper:rt(N)},c.reset=!1,c.placement=c.options.placement,c.orderedModifiers.forEach(function(k){return c.modifiersData[k.name]=Object.assign({},k.data)});for(var x=0;x<c.orderedModifiers.length;x++)if(c.reset!==!0){var O=c.orderedModifiers[x],g=O.fn,f=O.options,w=f===void 0?{}:f,b=O.name;typeof g=="function"&&(c=g({state:c,options:w,name:b,instance:E})||c)}else c.reset=!1,x=-1}}},update:(r=function(){return new Promise(function(D){E.forceUpdate(),D(c)})},function(){return h||(h=new Promise(function(D){Promise.resolve().then(function(){h=void 0,D(r())})})),h}),destroy:function(){m(),u=!0}};if(!Ut(o,l))return E;function m(){y.forEach(function(D){return D()}),y=[]}return E.setOptions(d).then(function(D){!u&&d.onFirstUpdate&&d.onFirstUpdate(D)}),E}}({defaultModifiers:[{name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:function(a){var e=a.state,t=a.instance,i=a.options,n=i.scroll,s=n===void 0||n,o=i.resize,l=o===void 0||o,d=Z(e.elements.popper),r=[].concat(e.scrollParents.reference,e.scrollParents.popper);return s&&r.forEach(function(h){h.addEventListener("scroll",t.update,We)}),l&&d.addEventListener("resize",t.update,We),function(){s&&r.forEach(function(h){h.removeEventListener("scroll",t.update,We)}),l&&d.removeEventListener("resize",t.update,We)}},data:{}},{name:"popperOffsets",enabled:!0,phase:"read",fn:function(a){var e=a.state,t=a.name;e.modifiersData[t]=Bt({reference:e.rects.reference,element:e.rects.popper,strategy:"absolute",placement:e.placement})},data:{}},{name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:function(a){var e=a.state,t=a.options,i=t.gpuAcceleration,n=i===void 0||i,s=t.adaptive,o=s===void 0||s,l=t.roundOffsets,d=l===void 0||l,r={placement:ie(e.placement),variation:we(e.placement),popper:e.elements.popper,popperRect:e.rects.popper,gpuAcceleration:n,isFixed:e.options.strategy==="fixed"};e.modifiersData.popperOffsets!=null&&(e.styles.popper=Object.assign({},e.styles.popper,Ht(Object.assign({},r,{offsets:e.modifiersData.popperOffsets,position:e.options.strategy,adaptive:o,roundOffsets:d})))),e.modifiersData.arrow!=null&&(e.styles.arrow=Object.assign({},e.styles.arrow,Ht(Object.assign({},r,{offsets:e.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:d})))),e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-placement":e.placement})},data:{}},ri,{name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:function(a){var e=a.state,t=a.options,i=a.name,n=t.offset,s=n===void 0?[0,0]:n,o=At.reduce(function(h,c){return h[c]=function(y,u,E){var m=ie(y),D=[Y,B].indexOf(m)>=0?-1:1,L=typeof E=="function"?E(Object.assign({},u,{placement:y})):E,N=L[0],x=L[1];return N=N||0,x=(x||0)*D,[Y,z].indexOf(m)>=0?{x,y:N}:{x:N,y:x}}(c,e.rects,s),h},{}),l=o[e.placement],d=l.x,r=l.y;e.modifiersData.popperOffsets!=null&&(e.modifiersData.popperOffsets.x+=d,e.modifiersData.popperOffsets.y+=r),e.modifiersData[i]=o}},pi,{name:"preventOverflow",enabled:!0,phase:"main",fn:function(a){var e=a.state,t=a.options,i=a.name,n=t.mainAxis,s=n===void 0||n,o=t.altAxis,l=o!==void 0&&o,d=t.boundary,r=t.rootBoundary,h=t.altBoundary,c=t.padding,y=t.tether,u=y===void 0||y,E=t.tetherOffset,m=E===void 0?0:E,D=Ce(e,{boundary:d,rootBoundary:r,padding:c,altBoundary:h}),L=ie(e.placement),N=we(e.placement),x=!N,O=ot(L),g=O==="x"?"y":"x",f=e.modifiersData.popperOffsets,w=e.rects.reference,b=e.rects.popper,k=typeof m=="function"?m(Object.assign({},e.rects,{placement:e.placement})):m,F=typeof k=="number"?{mainAxis:k,altAxis:k}:Object.assign({mainAxis:0,altAxis:0},k),I=e.modifiersData.offset?e.modifiersData.offset[e.placement]:null,S={x:0,y:0};if(f){if(s){var A,X=O==="y"?B:Y,P=O==="y"?U:z,H=O==="y"?"height":"width",_=f[O],R=_+D[X],ae=_-D[P],W=u?-b[H]/2:0,M=N==="start"?w[H]:b[H],$=N==="start"?-b[H]:-w[H],ce=e.elements.arrow,re=u&&ce?rt(ce):{width:0,height:0},q=e.modifiersData["arrow#persistent"]?e.modifiersData["arrow#persistent"].padding:{top:0,right:0,bottom:0,left:0},ke=q[X],Ae=q[P],pe=xe(0,w[H],re[H]),Ye=x?w[H]/2-W-pe-ke-F.mainAxis:M-pe-ke-F.mainAxis,je=x?-w[H]/2+W+pe+Ae+F.mainAxis:$+pe+Ae+F.mainAxis,ge=e.elements.arrow&&Oe(e.elements.arrow),Ge=ge?O==="y"?ge.clientTop||0:ge.clientLeft||0:0,De=(A=I==null?void 0:I[O])!=null?A:0,Fe=_+je-De,ue=xe(u?Me(R,_+Ye-De-Ge):R,_,u?de(ae,Fe):ae);f[O]=ue,S[O]=ue-_}if(l){var fe,Q=O==="x"?B:Y,le=O==="x"?U:z,he=f[g],Re=g==="y"?"height":"width",pt=he+D[Q],gt=he-D[le],Ue=[B,Y].indexOf(L)!==-1,ut=(fe=I==null?void 0:I[g])!=null?fe:0,ft=Ue?pt:he-w[Re]-b[Re]-ut+F.altAxis,mt=Ue?he+w[Re]+b[Re]-ut-F.altAxis:gt,yt=u&&Ue?function(ei,ti,ze){var Et=xe(ei,ti,ze);return Et>ze?ze:Et}(ft,he,mt):xe(u?ft:pt,he,u?mt:gt);f[g]=yt,S[g]=yt-he}e.modifiersData[i]=S}},requiresIfExists:["offset"]},li,{name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:function(a){var e=a.state,t=a.name,i=e.rects.reference,n=e.rects.popper,s=e.modifiersData.preventOverflow,o=Ce(e,{elementContext:"reference"}),l=Ce(e,{altBoundary:!0}),d=Yt(o,i),r=Yt(l,n,s),h=jt(d),c=jt(r);e.modifiersData[t]={referenceClippingOffsets:d,popperEscapeOffsets:r,isReferenceHidden:h,hasPopperEscaped:c},e.attributes.popper=Object.assign({},e.attributes.popper,{"data-popper-reference-hidden":h,"data-popper-escaped":c})}}]}),Kt=class{constructor(e,t,i,n=30){this.owner=e,this.containerEl=t,this.limit=n,this.owner=e,this.containerEl=t,t.on("click",".suggestion-item",this.onSuggestionClick.bind(this)),t.on("mousemove",".suggestion-item",this.onSuggestionMouseover.bind(this)),i.register([],"ArrowUp",s=>{if(!s.isComposing)return this.setSelectedItem(this.selectedItem-1,!0),!1}),i.register([],"ArrowDown",s=>{if(!s.isComposing)return this.setSelectedItem(this.selectedItem+1,!0),!1}),i.register([],"Enter",s=>{if(!s.isComposing)return this.useSelectedItem(s),!1})}onSuggestionClick(e,t){e.preventDefault();let i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1),this.useSelectedItem(e)}onSuggestionMouseover(e,t){let i=this.suggestions.indexOf(t);this.setSelectedItem(i,!1)}setSuggestions(e){this.containerEl.empty();let t=[];e.slice(0,this.limit).forEach(i=>{let n=this.containerEl.createDiv("suggestion-item");this.owner.renderSuggestion(i,n),t.push(n)}),this.values=e,this.suggestions=t,this.setSelectedItem(0,!1)}useSelectedItem(e){let t=this.values[this.selectedItem];t&&this.owner.selectSuggestion(t,e)}setSelectedItem(e,t){let i=(e%(n=this.suggestions.length)+n)%n;var n;let s=this.suggestions[this.selectedItem],o=this.suggestions[i];s==null||s.removeClass("is-selected"),o==null||o.addClass("is-selected"),this.selectedItem=i,t&&o.scrollIntoView(!1)}};(function(a){a[a.TemplateFiles=0]="TemplateFiles",a[a.ScriptFiles=1]="ScriptFiles"})(zt||(zt={}));var Xt=class extends class{constructor(e,t,i){this.app=e,this.inputEl=t,this.containerEl=i,this.scope=new T.Scope,this.suggestEl=i.createDiv("suggestion-container");let n=this.suggestEl.createDiv("suggestion");this.suggest=new Kt(this,n,this.scope),this.scope.register([],"Escape",this.close.bind(this)),this.inputEl.addEventListener("input",this.onInputChanged.bind(this)),this.inputEl.addEventListener("focus",this.onInputChanged.bind(this)),this.inputEl.addEventListener("blur",this.close.bind(this)),this.suggestEl.on("mousedown",".suggestion-container",s=>{s.preventDefault()})}onInputChanged(){let e=this.inputEl.value,t=this.getSuggestions(e);t&&t.length>0?(this.suggest.setSuggestions(t),this.open(this.containerEl,this.inputEl)):this.close()}open(e,t){this.app.keymap.pushScope(this.scope),e.appendChild(this.suggestEl),this.popper=fi(t,this.suggestEl,{placement:"bottom-start",modifiers:[{name:"sameWidth",enabled:!0,fn:({state:i,instance:n})=>{let s=`${i.rects.reference.width}px`;i.styles.popper.width!==s&&(i.styles.popper.width=s,n.update())},phase:"beforeWrite",requires:["computeStyles"]}]})}close(){this.app.keymap.popScope(this.scope),this.suggest.setSuggestions([]),this.popper&&this.popper.destroy(),this.suggestEl.detach()}}{constructor(e,t,i,n){super(e,t,n),this.plugin=i}getSuggestions(e){var t,i,n;if(e==="")return this.plugin.starred;let s=e.toLowerCase(),o=(t=this.plugin.pages)===null||t===void 0?void 0:t.getPages().filter(r=>(!r.file||(this.plugin.settings.showAttachments||r.file.extension==="md")&&!this.plugin.settings.excludeFilepaths.some(h=>r.path.startsWith(h)))&&(r.file||(this.plugin.settings.showFolderNodes||!r.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!r.path.startsWith("tag:")))&&r.name.toLowerCase().contains(s));if(o.length>30)return o;let l=o.concat((i=this.plugin.pages)===null||i===void 0?void 0:i.getPages().filter(r=>!o.contains(r)&&(!r.file||(this.plugin.settings.showAttachments||r.file.extension==="md")&&!this.plugin.settings.excludeFilepaths.some(h=>r.path.startsWith(h)))&&(r.file||(this.plugin.settings.showFolderNodes||!r.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!r.path.startsWith("tag:")))&&r.path.toLowerCase().contains(s)));if(l.length>30)return l;let d=T.prepareFuzzySearch(e);return l.concat((n=this.plugin.pages)===null||n===void 0?void 0:n.getPages().filter(r=>!r.isVirtual&&(!r.file||(this.plugin.settings.showAttachments||r.file.extension==="md")&&!this.plugin.settings.excludeFilepaths.some(h=>r.path.startsWith(h)))&&(r.file||(this.plugin.settings.showFolderNodes||!r.path.startsWith("folder:"))&&(this.plugin.settings.showTagNodes||!r.path.startsWith("tag:")))&&!l.contains(r)&&d(r.path)))}renderSuggestion(e,t){t.setText(e.path)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.trigger("input"),this.close()}},$t={exports:{}};$t.exports=(()=>{var a={858:(i,n,s)=>{s.r(n)},607:(i,n,s)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.Multiselect=void 0,s(858);var o=s(86);Object.defineProperty(n,"Multiselect",{enumerable:!0,get:function(){return o.Multiselect}})},51:(i,n)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.MultiselectOption=void 0;var s=function(){function o(l,d,r,h){this.label="",this.selected=!1,this.value=l,this.label=d,this.multiple=r,this.onChange=h,this.createOptionElement(),this.createListeners()}return o.prototype.select=function(l){l===void 0&&(l=!0),this.selected=!0,this.setAttribute(),l&&this.onChange(this)},o.prototype.deselect=function(l){l===void 0&&(l=!0),this.selected=!1,this.setAttribute(),l&&this.onChange(this)},o.prototype.createOptionElement=function(){var l=document.createElement("div");l.classList.add("option"),this.singleSelectTextSpanRef=document.createElement("span"),this.singleSelectTextSpanRef.classList.add("option-text"),this.singleSelectTextSpanRef.innerText=this.label,l.appendChild(this.singleSelectTextSpanRef),l.appendChild(this.createCheckbox()),this.optionRef=l},o.prototype.createCheckbox=function(){var l=document.createElement("label");l.classList.add("checkbox-wrapper");var d=document.createElement("span");d.classList.add("checkbox-text"),d.innerText=this.label;var r=document.createElement("input");r.setAttribute("type","checkbox"),this.checkboxRef=r;var h=document.createElement("span");return h.classList.add("checkbox-checkmark"),l.appendChild(d),l.appendChild(r),l.appendChild(h),l},o.prototype.setAttribute=function(){this.multiple?this.selected?this.checkboxRef.setAttribute("checked","checked"):this.checkboxRef.removeAttribute("checked"):this.selected?this.singleSelectTextSpanRef.classList.add("selected"):this.singleSelectTextSpanRef.classList.remove("selected")},o.prototype.createListeners=function(){var l=this;this.multiple?this.checkboxRef.addEventListener("change",function(){l.selected=l.checkboxRef.checked,l.onChange(l)}):this.singleSelectTextSpanRef.addEventListener("click",function(){l.selected=!0,l.onChange(l)})},o}();n.MultiselectOption=s},86:(i,n,s)=>{Object.defineProperty(n,"__esModule",{value:!0}),n.Multiselect=void 0;var o=s(51),l=function(){function d(r){var h=this;if(this.options=[],this.dropdownOpened=!1,this.destroyed=!1,this.rendered=!1,this.documentClickDropdownToggle=function(c){h.selectWrapperRef.contains(c.target)||h.handleDropdownToggle(!1,h.dropdownOpened)},this.config=r,this.assignConfig(),this.setOrigin(),!this.origin)throw"You have to pass origin element!";this.init()}return d.prototype.init=function(){this.destroyed=!1,this.dropdownOpened=!1,this.createSelect(),this.createListeners()},d.prototype.destroy=function(){this.destroyed=!0,this.rendered=!1,this.hide(),document.removeEventListener("click",this.documentClickDropdownToggle),this.selectWrapperRef.cloneNode(!0),this.origin=null,this.selectHeaderRef=null,this.selectWrapperRef=null,this.selectedValueRef=null,this.optionsWrapperRef=null,this.options=[]},d.prototype.reset=function(){this.options.forEach(function(r){return r.deselect(!1)}),this.updateSelection()},d.prototype.hide=function(){this.origin.innerHTML="",this.rendered=!1},d.prototype.render=function(){if(this.destroyed)throw"But you destroyed me... :(";if(this.origin.innerText.trim())throw"Hey! I am rendered already!";this.origin.appendChild(this.selectWrapperRef),this.rendered=!0,this.selectHeaderRef&&this.origin.prepend(this.selectHeaderRef)},d.prototype.assignConfig=function(){var r,h;this.id=this.config.id,this.configOptions=this.config.options,this.multiple=(r=this.config.multiple)===null||r===void 0||r,this.singularNominativeLabel=this.config.singularNominativeLabel,this.pluralNominativeLabel=this.config.pluralNominativeLabel,this.pluralGenitiveLabel=this.config.pluralGenitiveLabel,this.placeholder=(h=this.config.placeholder)!==null&&h!==void 0?h:"",this.headerLabel=this.config.headerLabel,this.selected=this.config.selected,this.onDropdownOpen=this.config.onDropdownOpen,this.onDropdownClose=this.config.onDropdownClose,this.onSelectionChange=this.config.onSelectionChange},d.prototype.setOrigin=function(){this.origin=document.querySelector("#"+this.id),this.origin&&this.origin.classList.add("multiselect-container")},d.prototype.createHeader=function(){this.headerLabel&&(this.selectHeaderRef=document.createElement("div"),this.selectHeaderRef.classList.add("multiselect-header"),this.selectHeaderRef.innerText=this.headerLabel)},d.prototype.createSelect=function(){var r=this;this.selectWrapperRef=document.createElement("div"),this.selectWrapperRef.classList.add("multiselect-wrapper"),this.multiple||this.selectWrapperRef.classList.add("single-select"),this.selectedValueRef=document.createElement("div"),this.selectedValueRef.classList.add("selected-value"),this.selectWrapperRef.appendChild(this.selectedValueRef),this.optionsWrapperRef=document.createElement("div"),this.optionsWrapperRef.classList.add("options-wrapper"),this.configOptions.forEach(function(h){var c,y=new o.MultiselectOption(h.value,h.label,r.multiple,r.onSelectChange.bind(r));((c=r.selected)===null||c===void 0?void 0:c.includes(h.value))&&y.select(!1),r.options.push(y),r.optionsWrapperRef.appendChild(y.optionRef)}),this.updateSelection(),this.selectWrapperRef.appendChild(this.optionsWrapperRef),this.createHeader(),this.render()},d.prototype.createListeners=function(){var r=this;this.selectWrapperRef.addEventListener("click",function(h){r.selectWrapperRef.contains(h.target)&&!r.optionsWrapperRef.contains(h.target)&&r.handleDropdownToggle(!r.dropdownOpened)}),document.addEventListener("click",this.documentClickDropdownToggle)},d.prototype.handleDropdownToggle=function(r,h){h===void 0&&(h=!0),this.dropdownOpened=r,this.dropdownOpened?(this.selectWrapperRef.classList.add("opened"),this.onDropdownOpen&&h&&this.onDropdownOpen()):(this.selectWrapperRef.classList.remove("opened"),this.onDropdownClose&&h&&this.onDropdownClose(this.selected))},d.prototype.onSelectChange=function(r){this.multiple||(this.options.forEach(function(h){return h.deselect(!1)}),r.select(!1)),this.updateSelection(),this.onSelectionChange&&this.onSelectionChange(this.selected),this.multiple||this.handleDropdownToggle(!1)},d.prototype.updateSelection=function(){this.selected=this.options.filter(function(c){return!!c.selected}).map(function(c){return c.value});var r=this.options.filter(function(c){return!!c.selected}).map(function(c){return c.label}),h=this.placeholder;r.length===1?h=r[0]:r.length>1&&(h=r.length+" "+this.transformPluralLabel(r.length)),this.selectedValueRef.innerText=h},d.prototype.transformPluralLabel=function(r){var h,c,y;return r===1?(h=this.singularNominativeLabel)!==null&&h!==void 0?h:"items":r%10>=2&&r%10<=4&&(r%100<10||r%100>=20)?(c=this.pluralNominativeLabel)!==null&&c!==void 0?c:"items":(y=this.pluralGenitiveLabel)!==null&&y!==void 0?y:"items"},d}();n.Multiselect=l}},e={};function t(i){if(e[i])return e[i].exports;var n=e[i]={exports:{}};return a[i](n,n.exports,t),n.exports}return t.r=i=>{typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},t(607)})();var qt=class{constructor(e,t){this.plugin=e,this.selectedLinks=new Set,this.selectedTags=new Set,this.isOpen=!1,this.filterDiv=t.createDiv({attr:{id:"filter"}})}render(){if(this.isOpen||(this.filterDiv.empty(),!this.plugin.scene))return;let e=Array.from(this.selectedTags);this.selectedLinks.forEach(o=>e.push("link::"+o));let t=[],i=new Set(this.selectedLinks.keys());this.plugin.scene.links.links.forEach(o=>{var l;(l=o.hierarchyDefinition)===null||l===void 0||l.split(",").map(d=>d.trim()).forEach(d=>i.add(d)),o.hierarchyDefinition||(o.isInferred?i.add("inferred-link"):i.add("normal-link"))}),i.forEach(o=>t.push({label:o,value:"link::"+o}));let n=new Set(this.selectedTags.keys());this.plugin.scene.nodesMap.forEach(o=>{o.page.primaryStyleTag&&n.add(o.page.primaryStyleTag)}),n.forEach(o=>t.push({label:o,value:o}));let s=new $t.exports.Multiselect({id:"filter",placeholder:"filter links and tags",options:t.sort((o,l)=>o.label>l.label?1:-1),selected:e,onDropdownOpen:()=>{this.isOpen=!0,this.selectedItems=s.selected},onSelectionChange:o=>{var l;this.selectedLinks.clear(),this.selectedTags.clear(),o.forEach(d=>{d.startsWith("link::")?this.selectedLinks.add(d.substring(6)):this.selectedTags.add(d)}),(l=this.plugin.scene)===null||l===void 0||l.reRender(!1)},onDropdownClose:o=>{var l;this.isOpen=!1,o!==this.selectedItems&&(console.log("rerender"),(l=this.plugin.scene)===null||l===void 0||l.reRender(!1))}})}},Jt=class{constructor(e,t){this.contentEl=e,this.plugin=t,this.buttons=[],e.addClass("excalibrain-contentEl"),this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-toolspanel-wrapper"});let i=this.wrapperDiv.createDiv({cls:"excalibrain-dropdown-wrapper"}),n=i.createEl("input",{type:"text",cls:"excalibrain-searchinput"});n.ariaLabel=p("SEARCH_IN_VAULT"),n.oninput=()=>{var l;let d=this.plugin.pages.get(n.value);d&&((l=this.plugin.scene)===null||l===void 0||l.renderGraphForPath(d.path))},n.onblur=()=>{n.value=""},new Xt(this.plugin.app,n,this.plugin,e),this.searchElement=n,this.linkTagFilter=new qt(t,i),this.linkTagFilter.render();let s=this.wrapperDiv.createDiv({cls:"excalibrain-buttons"}),o=s.createEl("button",{cls:"excalibrain-button",text:"\u270F"});o.ariaLabel=p("OPEN_DRAWING"),o.onclick=()=>{let l=this.plugin.EA.getExcalidrawAPI().getSceneElements(),d=this.plugin.EA.getExcalidrawAPI().getAppState(),r=this.plugin.EA;r.reset(),r.canvas.viewBackgroundColor=d.viewBackgroundColor,r.canvas.theme="light",l.forEach(h=>r.elementsDict[h.id]=h),r.create({filename:`ExcaliBrain Snapshot - ${ii(this.plugin.scene.centralPagePath).basename}`,onNewPane:!0})},this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.showAttachments,l=>this.plugin.settings.showAttachments=l,s,{display:"\u{1F4CE}",tooltip:p("SHOW_HIDE_ATTACHMENTS")})),this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.showVirtualNodes,l=>this.plugin.settings.showVirtualNodes=l,s,{display:"\u2205",tooltip:p("SHOW_HIDE_VIRTUAL")},!1)),this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.showInferredNodes,l=>this.plugin.settings.showInferredNodes=l,s,{display:"\u{1F914}",tooltip:p("SHOW_HIDE_INFERRED")})),this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.showPageNodes,l=>this.plugin.settings.showPageNodes=l,s,{display:"\u{1F4C4}",tooltip:p("SHOW_HIDE_PAGES")})),this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.showFolderNodes,l=>this.plugin.settings.showFolderNodes=l,s,{display:"\u{1F4C2}",tooltip:p("SHOW_HIDE_FOLDER")},!0)),this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.showTagNodes,l=>this.plugin.settings.showTagNodes=l,s,{display:"#",tooltip:p("SHOW_HIDE_TAG")},!1)),this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.renderAlias,l=>this.plugin.settings.renderAlias=l,s,{display:"\u{1F9E5}",tooltip:p("SHOW_HIDE_ALIAS")},!1)),this.buttons.push(new ee(this.plugin,()=>this.plugin.scene.pinLeaf,l=>this.plugin.scene.pinLeaf=l,s,{display:"\u{1F4CC}",tooltip:p("PIN_LEAF")},!1)),this.buttons.push(new ee(this.plugin,()=>this.plugin.settings.renderSiblings,l=>this.plugin.settings.renderSiblings=l,s,{display:"\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F466}",tooltip:p("SHOW_HIDE_SIBLINGS")},!1)),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.buttons.forEach(e=>e.setColor()),this.linkTagFilter.render()}terminate(){var e;if(this.contentEl&&this.contentEl.removeClass("excalibrain-contentEl"),this.wrapperDiv){try{(e=this.contentEl)===null||e===void 0||e.removeChild(this.wrapperDiv)}catch(t){}this.wrapperDiv=null}}},Zt=class{constructor(e,t){this.contentEl=e,this.plugin=t,this.wrapperDiv=this.contentEl.createDiv({cls:"excalibrain-history-wrapper"}),this.rerender(),this.contentEl.appendChild(this.wrapperDiv)}rerender(){this.wrapperDiv.empty();let e=this.wrapperDiv.createDiv({cls:"excalibrain-history-container"}),t=this.plugin.settings.navigationHistory;for(let i=t.length-1;i>=0;i--){i!==t.length-1&&e.createDiv({text:"\u2022",cls:"excalibrain-history-divider"});let n="",s="",o=this.plugin.pages.get(t[i]);if(!o)return;let l=o.path.startsWith("folder:")?this.plugin.settings.folderNodeStyle:o.path.startsWith("tag:")?this.plugin.settings.tagNodeStyle:Object.assign(Object.assign({},this.plugin.settings.baseNodeStyle),Nt(Te(o.dvPage,this.plugin.settings),this.plugin.settings));o.file?(n=l.prefix+o.getTitle(),s=o.path):(n=l.prefix+o.name,s=o.path),e.createDiv({text:n,cls:"excalibrain-history-item"},d=>{d.onclick=()=>{var r;return(r=this.plugin.scene)===null||r===void 0?void 0:r.renderGraphForPath(s)}})}}terminate(){var e;if(this.wrapperDiv){try{(e=this.contentEl)===null||e===void 0||e.removeChild(this.wrapperDiv)}catch(t){}this.wrapperDiv=null}}},ne=class{constructor(e,t,i){this.disregardLeafChange=!1,this.nodesMap=new Map,this.layouts=[],this.blockUpdateTimer=!1,this.vaultFileChanged=!1,this.pinLeaf=!1,this.focusSearchAfterInitiation=!0,this.ea=e.EA,this.plugin=e,this.app=e.app,this.leaf=i!=null?i:app.workspace.getLeaf(t),this.terminated=!1,this.links=new nt(e)}async initialize(e){this.focusSearchAfterInitiation=e,await this.plugin.loadSettings(),this.toolsPanel=new Jt(this.leaf.view.contentEl,this.plugin),await this.initializeScene(),this.historyPanel=new Zt(this.leaf.view.contentEl,this.plugin)}isActive(){var e;return!this.terminated&&app.workspace.getLeafById((e=this.leaf)===null||e===void 0?void 0:e.id)}async reRender(e=!0){this.isActive()&&this.centralLeaf&&this.centralPagePath&&(e&&await this.plugin.createIndex(),await this.render(),this.toolsPanel.rerender())}async renderGraphForPath(e){var t;if(!this.isActive())return;this.blockUpdateTimer=!0;let i=this.plugin.pages.get(e);if(!i)return void(this.blockUpdateTimer=!1);let n=!(i.isFolder||i.isTag||i.isVirtual);if(n&&!i.file)return void(this.blockUpdateTimer=!1);if(!((t=this.ea.targetView)===null||t===void 0?void 0:t.file)||this.ea.targetView.file.path!==this.plugin.settings.excalibrainFilepath)return void this.unloadScene();if(n&&i.file.path===this.ea.targetView.file.path)return void(this.blockUpdateTimer=!1);let s=this.plugin.pages.get(this.centralPagePath);if(s&&s.path===e&&n&&i.file.stat.mtime===s.mtime)return _e("!!!"),void(this.blockUpdateTimer=!1);n?(this.centralLeaf&&app.workspace.getLeafById(this.centralLeaf.id)?this.centralLeaf.openFile(i.file):this.centralLeaf=this.ea.openFileInNewOrAdjacentLeaf(i.file),this.addToHistory(i.file.path)):this.addToHistory(i.path),i.isFolder&&!this.plugin.settings.showFolderNodes&&(this.plugin.settings.showFolderNodes=!0,this.toolsPanel.rerender()),i.isTag&&!this.plugin.settings.showTagNodes&&(this.plugin.settings.showTagNodes=!0,this.toolsPanel.rerender()),this.centralPagePath=e,await this.render()}async addToHistory(e){let t=this.plugin.settings.navigationHistory;if(t.last()===e)return;let i=t.indexOf(e);i>-1&&t.splice(i,1),t.length>50&&t.shift(),t.push(e)}static async openExcalidrawLeaf(e,t,i){let n=0,s=app.vault.getAbstractFileByPath(t.excalibrainFilepath);if(!s||s instanceof T.TFile){if(!s)for(s=await app.vault.create(t.excalibrainFilepath,Ct);s instanceof T.TFile&&!e.isExcalidrawFile(s)&&n++<10;)await sleep(50);n=0,s&&s instanceof T.TFile&&!e.isExcalidrawFile(s)?new me(app,"\u26A0 File Exists",`${s.path} already exists in your Vault. Is it ok to overwrite this file? If not, change ExcaliBrain file path in plugin settings.`).show(async o=>{if(o){for(await app.vault.modify(s,Ct);s instanceof T.TFile&&!e.isExcalidrawFile(s)&&n++<10;)await sleep(50);ne.openExcalidrawLeaf(e,t,i)}else new T.Notice("Could not start ExcaliBrain. Please change the ExcaliBrain file path in plugin settings.")}):await(i!=null?i:app.workspace.getLeaf(!0)).openFile(s)}else new T.Notice(`Please check settings. ExcaliBrain path (${t.excalibrainFilepath}) points to a folder, not a file`)}async initializeScene(){this.disregardLeafChange=!1;let e=this.ea,t=this.plugin.settings.baseNodeStyle,i=0;for(e.clear(),e.setView(this.leaf.view),i=0;!e.targetView.excalidrawAPI&&i++<10;)await sleep(50);e.targetView.excalidrawAPI?(this.ea.registerThisAsViewEA(),this.ea.targetView.semaphores.saving=!0,this.ea.targetView.excalidrawAPI.setMobileModeAllowed(!1),e.style.fontFamily=t.fontFamily,e.style.fontSize=t.fontSize,this.textSize=e.measureText("m".repeat(t.maxLabelLength+3)),this.nodeWidth=this.textSize.width+3*t.padding,this.nodeHeight=2*(this.textSize.height+2*t.padding),e.getExcalidrawAPI().updateScene({appState:{viewModeEnabled:!0,activeTool:{lastActiveToolBeforeEraser:null,locked:!1,type:"selection"},theme:"light",viewBackgroundColor:this.plugin.settings.backgroundColor},elements:[]}),e.style.strokeColor=t.textColor,e.addText(0,0,`\u{1F680} To get started
select a document using the search in the top left or
open a document in another pane.

\u2728 For the best experience enable 'Open in adjacent pane'
in Excalidraw settings under 'Links and Transclusion'.

\u26A0 ExcaliBrain may need to wait for DataView to initialize its index.
This can take up to a few minutes after starting Obsidian.`,{textAlign:"center"}),await e.addElementsToView(),e.getExcalidrawAPI().zoomToFit(null,5,.15),e.targetView.linksAlwaysOpenInANewPane=!0,this.addEventHandler(),new T.Notice("ExcaliBrain On")):new T.Notice("Error initializing Excalidraw view")}addNodes(e){e.neighbours.forEach(t=>{if(t.page.path===this.ea.targetView.file.path)return;let i=new ye({page:t.page,isInferred:t.relationType===v.INFERRED,isCentral:e.isCentral,isSibling:e.isSibling,friendGateOnLeft:e.friendGateOnLeft});this.nodesMap.set(t.page.path,i),e.layout.nodes.push(i)})}async render(){var e,t;this.historyPanel&&this.historyPanel.rerender(),this.ea.clear(),this.ea.getExcalidrawAPI().updateScene({elements:[]}),this.ea.style.verticalAlign="middle";let i=this.plugin.pages.get(this.centralPagePath);i.getParents().forEach(S=>S.page.primaryStyleTag=Te(S.page.dvPage,this.plugin.settings));let n=i.getParents().filter(S=>!(S.page.path===i.path||this.plugin.settings.excludeFilepaths.some(A=>S.page.path.startsWith(A))||S.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(S.page.primaryStyleTag))).slice(0,this.plugin.settings.maxItemCount),s=n.map(S=>S.page.path);i.getChildren().forEach(S=>S.page.primaryStyleTag=Te(S.page.dvPage,this.plugin.settings));let o=i.getChildren().filter(S=>!(S.page.path===i.path||this.plugin.settings.excludeFilepaths.some(A=>S.page.path.startsWith(A))||S.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(S.page.primaryStyleTag))).slice(0,this.plugin.settings.maxItemCount);i.getFriends().forEach(S=>S.page.primaryStyleTag=Te(S.page.dvPage,this.plugin.settings));let l=i.getFriends().filter(S=>!(S.page.path===i.path||this.plugin.settings.excludeFilepaths.some(A=>S.page.path.startsWith(A))||S.page.primaryStyleTag&&this.toolsPanel.linkTagFilter.selectedTags.has(S.page.primaryStyleTag))).slice(0,this.plugin.settings.maxItemCount);i.getSiblings().forEach(S=>S.page.primaryStyleTag=Te(S.page.dvPage,this.plugin.settings));let d=i.getSiblings().filter(S=>!(n.some(A=>A.page.path===S.page.path)||o.some(A=>A.page.path===S.page.path)||l.some(A=>A.page.path===S.page.path)||this.plugin.settings.excludeFilepaths.some(A=>S.page.path.startsWith(A)))&&S.page.path!==i.path&&S.page.getParents().map(A=>A.page.path).some(A=>s.includes(A))&&(!S.page.primaryStyleTag||!this.toolsPanel.linkTagFilter.selectedTags.has(S.page.primaryStyleTag))).slice(0,this.plugin.settings.maxItemCount);this.nodesMap=new Map,this.links=new nt(this.plugin),this.layouts=[];let r=o.length>10,h=d.length>10,c=n.length<=1,y=this.plugin.settings.baseNodeStyle,u=new Ee({origoX:0,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(u);let E=new Ee({origoX:0,origoY:2.5*this.nodeHeight,top:2*this.nodeHeight,bottom:null,columns:r?5:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(E);let m=new Ee({origoX:(r?-3:-2)*this.nodeWidth,origoY:0,top:null,bottom:null,columns:1,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(m);let D=new Ee({origoX:0,origoY:-2.5*this.nodeHeight,top:null,bottom:-2*this.nodeHeight,columns:3,columnWidth:this.nodeWidth,rowHeight:this.nodeHeight});this.layouts.push(D);let L=this.plugin.settings.siblingNodeStyle,N=(e=L.padding)!==null&&e!==void 0?e:y.padding,x=(t=L.maxLabelLength)!==null&&t!==void 0?t:y.maxLabelLength;this.ea.style.fontFamily=L.fontFamily,this.ea.style.fontSize=L.fontSize;let O=this.ea.measureText("m".repeat(x+3)),g=O.width+3*N,f=2*(O.height+2*N),w=new Ee({origoX:1.3*this.nodeWidth*((c?0:1)+(h?2:1)),origoY:-2.5*this.nodeHeight,top:null,bottom:0,columns:h?3:1,columnWidth:g,rowHeight:f});this.layouts.push(w);let b=new ye({page:i,isInferred:!1,isCentral:!0,isSibling:!1,friendGateOnLeft:!0});this.nodesMap.set(i.path,b),u.nodes.push(b),this.addNodes({neighbours:n,layout:D,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:o,layout:E,isCentral:!1,isSibling:!1,friendGateOnLeft:!0}),this.addNodes({neighbours:l,layout:m,isCentral:!1,isSibling:!1,friendGateOnLeft:!1}),this.plugin.settings.renderSiblings&&this.addNodes({neighbours:d,layout:w,isCentral:!1,isSibling:!0,friendGateOnLeft:!0});let k=(S,A,X)=>{A.forEach(P=>{let H=this.nodesMap.get(P.page.path);H&&this.links.addLink(S,H,X,P.relationType,P.typeDefinition,P.linkDirection,this.ea,this.plugin.settings)})};Array.from(this.nodesMap.values()).forEach(S=>{k(S,S.page.getChildren(),V.CHILD),k(S,S.page.getParents(),V.PARENT),k(S,S.page.getFriends(),V.FRIEND)}),this.ea.style.opacity=100,this.layouts.forEach(S=>S.render());let F=this.ea.getElements();this.links.render(Array.from(this.toolsPanel.linkTagFilter.selectedLinks));let I=this.ea.getElements().filter(S=>!F.includes(S));this.ea.getExcalidrawAPI().updateScene({elements:I.concat(F)}),this.ea.getExcalidrawAPI().zoomToFit(null,5,.15),this.toolsPanel.rerender(),this.focusSearchAfterInitiation&&(this.toolsPanel.searchElement.focus(),this.focusSearchAfterInitiation=!1),this.blockUpdateTimer=!1}isCentralLeafStillThere(){return app.workspace.getLeafById(this.centralLeaf.id)!==null}async addEventHandler(){let e=this,t=async o=>{var l;if(this.disregardLeafChange||(e.blockUpdateTimer=!0,await new Promise(h=>setTimeout(h,100)),this.pinLeaf&&!this.isCentralLeafStillThere()&&(this.pinLeaf=!1,this.toolsPanel.rerender()),this.pinLeaf&&o!==this.centralLeaf))return;if(!((l=e.ea.targetView)===null||l===void 0?void 0:l.file)||e.ea.targetView.file.path!==e.plugin.settings.excalibrainFilepath)return void e.unloadScene();if(!((o==null?void 0:o.view)&&o.view instanceof T.FileView&&o.view.file))return void(e.blockUpdateTimer=!1);let d=o.view.file;if(d.path===e.ea.targetView.file.path)return void(e.blockUpdateTimer=!1);let r=e.plugin.pages.get(e.centralPagePath);r&&r.path===d.path&&d.stat.mtime===r.mtime?e.blockUpdateTimer=!1:(e.plugin.pages.get(d.path)||await e.plugin.createIndex(),this.addToHistory(d.path),e.centralPagePath=d.path,e.centralLeaf=o,e.render())},i=()=>{this.vaultFileChanged=!0};app.workspace.on("active-leaf-change",t),this.removeEH=()=>app.workspace.off("active-leaf-change",t);let n=setInterval(async()=>{this.blockUpdateTimer||this.vaultFileChanged&&(this.vaultFileChanged=!1,await this.plugin.createIndex(),this.centralPagePath&&(this.plugin.pages.get(this.centralPagePath)||this.centralLeaf&&this.centralLeaf.view&&this.centralLeaf.view.file&&(this.centralPagePath=this.centralLeaf.view.file.path)),this.render())},5e3);this.removeTimer=()=>clearInterval(n),app.vault.on("rename",i),this.removeOnRename=()=>app.vault.off("rename",i),app.vault.on("modify",i),this.removeOnModify=()=>app.vault.off("modify",i),app.vault.on("create",i),this.removeOnCreate=()=>app.vault.off("create",i),app.vault.on("delete",i),this.removeOnDelete=()=>app.vault.off("delete",i);let s=[];app.workspace.iterateAllLeaves(o=>{o.view instanceof T.FileView&&o.view.file&&o.view.file.path!==this.ea.targetView.file.path&&s.push(o)}),await this.plugin.createIndex(),s.length>0&&t(s[0])}unloadScene(){var e,t;if(this.removeEH&&(this.removeEH(),this.removeEH=void 0),this.removeTimer&&(this.removeTimer(),this.removeTimer=void 0),this.removeOnRename&&(this.removeOnRename(),this.removeOnRename=void 0),this.removeOnModify&&(this.removeOnModify(),this.removeOnModify=void 0),this.removeOnCreate&&(this.removeOnCreate(),this.removeOnCreate=void 0),this.removeOnDelete&&(this.removeOnDelete(),this.removeOnDelete=void 0),this.ea.targetView&&isBoolean(this.ea.targetView.linksAlwaysOpenInANewPane)&&(this.ea.targetView.linksAlwaysOpenInANewPane=!1),this.ea.targetView&&this.ea.targetView.excalidrawAPI)try{this.ea.targetView.semaphores.saving=!1,this.ea.targetView.excalidrawAPI.setMobileModeAllowed(!0),this.ea.targetView.excalidrawAPI.updateScene({appState:{viewModeEnabled:!1}})}catch(i){}if(this.ea.targetView&&this.ea.targetView._loaded)try{this.ea.deregisterThisAsViewEA()}catch(i){}(async()=>{let i=this.plugin.settings.navigationHistory.slice();await this.plugin.loadSettings(),this.plugin.settings.navigationHistory=i,await this.plugin.saveSettings()})(),(e=this.toolsPanel)===null||e===void 0||e.terminate(),this.toolsPanel=void 0,(t=this.historyPanel)===null||t===void 0||t.terminate(),this.historyPanel=void 0,this.ea.targetView=void 0,this.leaf=void 0,this.centralLeaf=void 0,this.centralPagePath=void 0,this.terminated=!0,app.plugins.plugins["obsidian-excalidraw-plugin"]||(this.plugin.EA=null),new T.Notice("Brain Graph Off")}},Qt=class extends T.Plugin{constructor(e,t){super(e,t),this.hierarchyLowerCase={parents:[],children:[],friends:[]},this.scene=null,this.pluginLoaded=!1,this.starred=[],this.focusSearchAfterInitiation=!1,this.starred=[new J("Initializing index, please wait",null,this,!1,!1,"Initializing index, please wait")]}async onload(){await this.loadSettings(),this.addSettingTab(new xt(this.app,this)),this.app.workspace.onLayoutReady(()=>{this.DVAPI=ni(),this.DVAPI?(this.EA=Je(),this.EA?this.EA.verifyMinimumPluginVersion("1.6.33")?(this.registerCommands(),this.registerExcalidrawAutomateHooks(),this.pluginLoaded=!0):new me(app,"\u26A0 ExcaliBrain Disabled: Please upgrade Excalidraw and try again",p("EXCALIDRAW_MINAPP_VERSION")).show(async e=>{new T.Notice("Disabling ExcaliBrain Plugin",8e3),Le({fn:this.onload,where:"main.ts/onload()",message:"ExcaliBrain requires a new version of Excalidraw"}),this.app.plugins.disablePlugin("excalibrain")}):new me(app,"\u26A0 ExcaliBrain Disabled: Excalidraw Plugin not found",p("EXCALIDRAW_NOT_FOUND")).show(async e=>{new T.Notice("Disabling ExcaliBrain Plugin",8e3),Le({fn:this.onload,where:"main.ts/onload()",message:"Excalidraw not found"}),this.app.plugins.disablePlugin("excalibrain")})):new me(app,"\u26A0 ExcaliBrain Disabled: DataView Plugin not found",p("DATAVIEW_NOT_FOUND")).show(async e=>{new T.Notice("Disabling ExcaliBrain Plugin",8e3),Le({fn:this.onload,where:"main.ts/onload()",message:"Dataview not found"}),this.app.plugins.disablePlugin("excalibrain")})})}async createIndex(){this.pages=new It(this);let e=0;for(;this.app.metadataCache.inProgressTaskCount>0||this.DVAPI.index.importer.reloadQueue.length>0;)e++%100==10&&new T.Notice("ExcaliBrain is waiting for Dataview to update its index",1e3),await sleep(100);let t=(l,d)=>{l.children.forEach(r=>{if(r instanceof T.TFolder){let h=new J("folder:"+r.path,null,this,!0,!1,r.name);return this.pages.add("folder:"+r.path,h),h.addParent(d,v.DEFINED,C.FROM,"file-tree"),d.addChild(h,v.DEFINED,C.TO,"file-tree"),void t(r,h)}{let h=new J(r.path,r,this);this.pages.add(r.path,h),h.addParent(d,v.DEFINED,C.FROM,"file-tree"),d.addChild(h,v.DEFINED,C.TO,"file-tree")}})},i=app.vault.getRoot(),n=new J("folder:/",null,this,!0,!1,"/");this.pages.add("folder:/",n),t(i,n),Object.keys(app.metadataCache.getTags()).map(l=>l.substring(1).split("/")).forEach(l=>{let d=[];l.forEach((r,h,c)=>{let y="tag:"+c.slice(0,h+1).join("/"),u=this.pages.get(y);if(u)d.push(u);else if(u=new J(y,null,this,!1,!0,r),this.pages.add(y,u),d.push(u),h>0){let E=d[h-1];u.addParent(E,v.DEFINED,C.FROM,"tag-tree"),E.addChild(u,v.DEFINED,C.TO,"tag-tree")}})}),this.pages.addUnresolvedLinks(),this.pages.addResolvedLinks(),this.pages.forEach(l=>{(l==null?void 0:l.file)&&this.pages.addDVFieldLinksToPage(l)});let o=this;setTimeout(async()=>{o.starred=(await app.internalPlugins.getPluginById("starred").loadData()).items.filter(l=>l.type==="file").map(l=>l.path).filter(l=>l!==o.settings.excalibrainFilepath&&o.pages.has(l)).map(l=>o.pages.get(l))})}excalidrawAvailable(){let e=Je();return e?(this.EA||(this.EA=e,this.registerExcalidrawAutomateHooks()),!0):(this.EA=null,this.scene&&this.scene.unloadScene(),new T.Notice("ExcaliBrain: Please start Excalidraw and try again.",4e3),!1)}revealBrainLeaf(){var e;if(!this.scene||this.scene.terminated)return;app.workspace.revealLeaf(this.scene.leaf);let t=app.plugins.getPlugin("obsidian-hover-editor");if(t){let n=t.activePopovers.filter(s=>s.leaves()[0]===this.scene.leaf)[0];n&&this.scene.leaf.view.containerEl.offsetHeight===0&&n.titleEl.querySelector("a.popover-action.mod-minimize").click()}let i=(e=this.scene.toolsPanel)===null||e===void 0?void 0:e.searchElement;i==null||i.focus()}registerCommands(){this.addCommand({id:"excalibrain-start",name:p("COMMAND_START"),callback:async()=>{if(!this.excalidrawAvailable())return;if(this.scene&&!this.scene.terminated)return void this.revealBrainLeaf();let e=this.getBrainLeaf();if(e)return this.scene=new ne(this,!0,e),this.scene.initialize(!0),void this.revealBrainLeaf();this.focusSearchAfterInitiation=!0,await ne.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,e)}}),this.addCommand({id:"excalibrain-open-hover",name:p("COMMAND_START_HOVER"),checkCallback:e=>{let t=app.plugins.getPlugin("obsidian-hover-editor");if(e)return t;if(this.excalidrawAvailable())if(!this.scene||this.scene.terminated)try{let i=this.getBrainLeaf();if(i){let s=t.activePopovers.filter(o=>o.leaves()[0]===i)[0];if(s)return app.workspace.revealLeaf(i),i.view.containerEl.offsetHeight===0&&s.titleEl.querySelector("a.popover-action.mod-maximize").click(),this.scene=new ne(this,!0,i),void this.scene.initialize(!0)}let n=t.spawnPopover(void 0,()=>{if(this.app.workspace.setActiveLeaf(n,!1,!0),!t.activePopovers.filter(s=>s.leaves()[0]===n)[0])return new T.Notice(p("HOVER_EDITOR_ERROR"),6e3),!1;setTimeout(()=>app.commands.commands["obsidian-hover-editor:snap-active-popover-to-viewport"].checkCallback(!1)),this.focusSearchAfterInitiation=!0,ne.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,n)})}catch(i){new T.Notice(p("HOVER_EDITOR_ERROR"),6e3)}else this.revealBrainLeaf()}})}getBrainLeaf(){let e;return app.workspace.iterateAllLeaves(t=>{t.view&&this.EA.isExcalidrawView(t.view)&&t.view.file.path===this.settings.excalibrainFilepath&&(e=t)}),e}registerExcalidrawAutomateHooks(){this.EA.onViewModeChangeHook=e=>{var t;this.EA.targetView&&((t=this.EA.targetView.file)===null||t===void 0?void 0:t.path)===this.settings.excalibrainFilepath&&(e||this.stop())},this.EA.onLinkHoverHook=(e,t)=>{var i;return!(this.scene&&this.EA.targetView&&((i=this.EA.targetView.file)===null||i===void 0?void 0:i.path)===this.settings.excalibrainFilepath&&this.EA.targetView.excalidrawAPI&&this.EA.targetView.excalidrawAPI.getAppState().viewModeEnabled&&(this.scene.disregardLeafChange=!0,this.disregardLeafChangeTimer&&clearTimeout(this.disregardLeafChangeTimer),this.disregardLeafChangeTimer=setTimeout(()=>{this.disregardLeafChangeTimer=null,this.scene&&(this.scene.disregardLeafChange=!1)},1e3),0))},this.EA.onLinkClickHook=(e,t,i)=>{var n,s,o,l,d,r,h,c,y;let u=t.match(/\[\[([^\]]*)/)[1],E=this.pages.get(u);if(!i.shiftKey&&E&&E.isVirtual)return(n=this.scene)===null||n===void 0||n.renderGraphForPath(u),!1;if(!t.startsWith("[[folder:")&&!t.startsWith("[[tag:")){if(((d=(l=(o=(s=this.scene)===null||s===void 0?void 0:s.centralLeaf)===null||o===void 0?void 0:o.view)===null||l===void 0?void 0:l.file)===null||d===void 0?void 0:d.path)===u)return(r=this.scene)===null||r===void 0||r.renderGraphForPath(u),!1;if(((h=this.scene)===null||h===void 0?void 0:h.pinLeaf)&&((c=this.scene)===null||c===void 0?void 0:c.isCentralLeafStillThere())){let m=app.vault.getAbstractFileByPath(u.split("#")[0]);if(m&&m instanceof T.TFile)return this.scene.centralLeaf.openFile(m),this.scene.renderGraphForPath(u),!1}return!0}return(y=this.scene)===null||y===void 0||y.renderGraphForPath(u),!1},this.EA.onViewUnloadHook=e=>{this.scene&&this.scene.leaf===e.leaf&&this.stop()}}onunload(){this.scene&&(this.scene.unloadScene(),this.scene=null)}setHierarchyLinkStylesExtended(){this.hierarchyLinkStylesExtended={},Object.entries(this.settings.hierarchyLinkStyles).forEach(e=>{let t=e[0].toLowerCase().replaceAll(" ","-");this.hierarchyLinkStylesExtended[e[0]]=e[1],e[0]!==t&&(this.hierarchyLinkStylesExtended[t]=e[1])})}async loadSettings(){this.settings=Object.assign({},si,await this.loadData()),this.settings.baseLinkStyle=Object.assign(Object.assign({},wt),this.settings.baseLinkStyle),this.settings.baseNodeStyle=Object.assign(Object.assign({},Dt),this.settings.baseNodeStyle),this.hierarchyLowerCase.parents=[],this.settings.hierarchy.parents.forEach(e=>this.hierarchyLowerCase.parents.push(e.toLowerCase().replaceAll(" ","-"))),this.hierarchyLowerCase.children=[],this.settings.hierarchy.children.forEach(e=>this.hierarchyLowerCase.children.push(e.toLowerCase().replaceAll(" ","-"))),this.hierarchyLowerCase.friends=[],this.settings.hierarchy.friends.forEach(e=>this.hierarchyLowerCase.friends.push(e.toLowerCase().replaceAll(" ","-"))),this.setHierarchyLinkStylesExtended(),this.linkStyles={},this.linkStyles.base={style:this.settings.baseLinkStyle,allowOverride:!1,userStyle:!1,display:p("LINKSTYLE_BASE"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles.inferred={style:this.settings.inferredLinkStyle,allowOverride:!0,userStyle:!1,display:p("LINKSTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["file-tree"]={style:this.settings.folderLinkStyle,allowOverride:!0,userStyle:!1,display:p("LINKSTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseLinkStyle},this.linkStyles["tag-tree"]={style:this.settings.tagLinkStyle,allowOverride:!0,userStyle:!1,display:p("LINKSTYLE_TAG"),getInheritedStyle:()=>this.settings.baseLinkStyle},Object.entries(this.settings.hierarchyLinkStyles).forEach(e=>{Pe.contains(e[0])||(this.linkStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseLinkStyle})}),this.nodeStyles={},this.nodeStyles.base={style:this.settings.baseNodeStyle,allowOverride:!1,userStyle:!1,display:p("NODESTYLE_BASE"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.inferred={style:this.settings.inferredNodeStyle,allowOverride:!0,userStyle:!1,display:p("NODESTYLE_INFERRED"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.virtual={style:this.settings.virtualNodeStyle,allowOverride:!0,userStyle:!1,display:p("NODESTYLE_VIRTUAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.central={style:this.settings.centralNodeStyle,allowOverride:!0,userStyle:!1,display:p("NODESTYLE_CENTRAL"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.sibling={style:this.settings.siblingNodeStyle,allowOverride:!0,userStyle:!1,display:p("NODESTYLE_SIBLING"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.attachment={style:this.settings.attachmentNodeStyle,allowOverride:!0,userStyle:!1,display:p("NODESTYLE_ATTACHMENT"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.folder={style:this.settings.folderNodeStyle,allowOverride:!0,userStyle:!1,display:p("NODESTYLE_FOLDER"),getInheritedStyle:()=>this.settings.baseNodeStyle},this.nodeStyles.tag={style:this.settings.tagNodeStyle,allowOverride:!0,userStyle:!1,display:p("NODESTYLE_TAG"),getInheritedStyle:()=>this.settings.baseNodeStyle},Object.entries(this.settings.tagNodeStyles).forEach(e=>{this.nodeStyles[e[0]]={style:e[1],allowOverride:!0,userStyle:!0,display:e[0],getInheritedStyle:()=>this.settings.baseNodeStyle}})}async saveSettings(){await this.saveData(this.settings)}stop(){this.scene&&!this.scene.terminated&&(this.scene.unloadScene(),this.scene=null)}async start(e){if(!e.view)return;let t=0;for(;!this.pluginLoaded&&t++<100;)await sleep(50);if(!this.pluginLoaded)return new T.Notice("ExcaliBrain plugin did not load - aborting start()"),void Le({where:"ExcaliBrain.start()",fn:this.start,message:"ExcaliBrain did not load. Aborting after 5000ms of trying"});this.excalidrawAvailable()&&(this.stop(),e?(this.scene=new ne(this,!0,e),this.scene.initialize(this.focusSearchAfterInitiation),this.focusSearchAfterInitiation=!1):await ne.openExcalidrawLeaf(window.ExcalidrawAutomate,this.settings,this.getBrainLeaf()))}};module.exports=Qt;
